# WARNING: DO NOT EDIT THIS FILE
# To override settings from this file, you can copy and paste the relevant
# sections into your printer.cfg and change it there.

[gcode_macro PID_CALIBRATE_HOTEND]
description: Perform a PID calibration test for a given extruder heater.
gcode:
	# parameter
	{% set toolhead = params.TOOLHEAD|default(-1)|int %}
	{% set temp = params.TEMP|default(220)|int %}

	DEBUG_ECHO PREFIX="PID_CALIBRATE_HOTEND" MSG="TEMP={temp}"

	# calibrate hotend heater
	{% if printer["dual_carriage"] is not defined %}
		# DEFAULT
		RATOS_ECHO MSG="PID calibration hotend heater T0 at {temp}째C..."
		PID_CALIBRATE HEATER=extruder TARGET={temp}
		_CONSOLE_SAVE_CONFIG
	{% else %}
		# IDEX
		{% if toolhead==0 or toolhead==1 %}
			RATOS_ECHO MSG="PID calibration hotend heater T{toolhead} at {temp}째C..."
			PID_CALIBRATE HEATER=extruder{'' if toolhead==0 else toolhead} TARGET={temp}
			_CONSOLE_SAVE_CONFIG
		{% else %}
			RATOS_ECHO MSG="Please select toolhead! 0 = left, 1 = right toolhead"
		{% endif %}
	{% endif %}

	_LEARN_MORE_CALIBRATION


[gcode_macro PID_CALIBRATE_BED]
description: Perform a PID calibration test for the bed heater.
gcode:
	# parameter
	{% set temp = params.TEMP|default(80)|int %}

	DEBUG_ECHO PREFIX="PID_CALIBRATE_BED" MSG="TEMP={temp}"
	RATOS_ECHO MSG="PID calibration bed heater at {temp}째C..."

	# calibrate bed heater
	PID_CALIBRATE HEATER=heater_bed TARGET={temp}

	_CONSOLE_SAVE_CONFIG
	_LEARN_MORE_CALIBRATION


[gcode_macro PID_CALIBRATE_CHAMBER_HEATER]
description: Perform a PID calibration test for the chamber heater.
gcode:
	# parameter
	{% set temp = params.TEMP|default(150)|int %}

	DEBUG_ECHO PREFIX="PID_CALIBRATE_CHAMBER_HEATER" MSG="TEMP={temp}"

	{% if printer["heater_generic chamber_heater"] is defined %}
		RATOS_ECHO MSG="PID calibration chamber heater at {temp}째C..."
		PID_CALIBRATE HEATER=chamber_heater TARGET={temp}
		_CONSOLE_SAVE_CONFIG
		_LEARN_MORE_CALIBRATION
	{% else %}
		{% set link_url = "https://github.com/HelgeKeck/RatOS/tree/documentation_v2.1/site/docs/configuration/chamber_heater.md" %}
		{% set link_text = "RatOS Chamber Heater" %}
		{% set line_1 = '"Learn more about the <a href="%s" target="_blank" >%s</a>"' % (link_url, link_text) %}
		CONSOLE_ECHO TITLE="No chamber heater found" TYPE="warning" MSG={line_1}
	{% endif %}


[gcode_macro INITIALIZE_PA_TUNING]
description: Start a pressure advance tuning tower.
gcode:
	# parameter
	{% set start = params.START|default(0.0)|float %}
	{% set factor = params.FACTOR|default(0.001)|float %}

	# config
	{% set layer_number = printer["gcode_macro _ON_LAYER_CHANGE"].layer_number|default(0)|int %}
	{% set is_printing_gcode = true if printer["gcode_macro START_PRINT"].is_printing_gcode|default(true)|lower == 'true' else false %}

	# initialize PA tuning 
	{% if is_printing_gcode and layer_number < 2 %}
		DEBUG_ECHO PREFIX="START_PA_TOWER" MSG="START: {start}, FACTOR: {factor}"
		RATOS_ECHO MSG="Starting presssure advance tuning tower..."
		TUNING_TOWER COMMAND=SET_PRESSURE_ADVANCE PARAMETER=ADVANCE START={start} FACTOR={factor}
	{% endif %}

	_LEARN_MORE_CALIBRATION
