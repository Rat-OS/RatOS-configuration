# WARNING: DO NOT EDIT THIS FILE
# To override settings from this file, you can copy and paste the relevant
# sections into your printer.cfg and change it there.


[gcode_macro RatOS]
variable_chamber_filter_enable: True                     # True|False = enable chamber filter control
variable_chamber_filter_speed: 1.0                       # float = chamber filter fan speed.
variable_chamber_filter_enable_at: "after_print_start"   # before_print_start|after_print_start|print_end = when to enable the filter
variable_chamber_filter_disable_period: 300              # int = disable fan after X seconds after the print ends
variable_chamber_filter_disable_bed_temp: 0              # int = wait for X°C bed temp after the print ends before disabling the filter


[gcode_macro _CHAMBER_FILTER_ON]
gcode:
	# parameters 
	{% set at = params.AT|default('')|lower %}

	# config
	{% set chamber_filter_speed = printer["gcode_macro RatOS"].chamber_filter_speed|default(0)|float %}
	{% set chamber_filter_enable = true if printer["gcode_macro RatOS"].chamber_filter_enable|default(true)|lower == 'true' else false %}
	{% set chamber_filter_enable_at = printer["gcode_macro RatOS"].chamber_filter_enable_at|default('after_print_start')|lower %}

	DEBUG_ECHO PREFIX="_CHAMBER_FILTER_ON" MSG="at: {at}, chamber_filter_enable: {chamber_filter_enable}, chamber_filter_enable_at: {chamber_filter_enable_at}, chamber_filter_speed: {chamber_filter_speed}"

	# turn filter fan on
	{% if chamber_filter_enable and printer["fan_generic filter"] is defined %}
		{% if chamber_filter_enable_at == at %}

			# echo
			RATOS_ECHO PREFIX="CHAMBER_FILTER" MSG="Activating chamber filter..."

			# set fan speed
			SET_FAN_SPEED FAN=filter SPEED={chamber_filter_speed}

			# visual feedback
			{% if chamber_filter_enable_at == "print_end" %}
				_LED_CHAMBER_FILTER_ON
			{% endif %}

		{% endif %}
	{% endif %}


[gcode_macro _CHAMBER_FILTER_OFF]
gcode:
	# config
	{% set chamber_filter_enable = true if printer["gcode_macro RatOS"].chamber_filter_enable|default(true)|lower == 'true' else false %}
	{% set filter_disable_period = printer["gcode_macro RatOS"].chamber_filter_disable_period|default(0)|int %}
	{% set filter_disable_bed_temp = printer["gcode_macro RatOS"].chamber_filter_disable_bed_temp|default(0)|int %}

	DEBUG_ECHO PREFIX="_CHAMBER_FILTER_OFF" MSG="chamber_filter_enable: {chamber_filter_enable}, filter_disable_period: {filter_disable_period}, filter_disable_bed_temp: {filter_disable_bed_temp}"

	# turn filter fan off
	{% if chamber_filter_enable and printer["fan_generic filter"] is defined %}

		# wait x seconds to turn filter off
		{% if filter_disable_period > 0 %}
			RATOS_ECHO PREFIX="CHAMBER_FILTER" MSG="Waiting {filter_disable_period} seconds before turning chamber filter off..."
			UPDATE_DELAYED_GCODE ID=_CHAMBER_FILTER_OFF_TIMER DURATION={filter_disable_period}
		{% endif %}

		# wait for bed temp to turn filter off
		{% if filter_disable_bed_temp > 0 %}
			RATOS_ECHO PREFIX="CHAMBER_FILTER" MSG="Waiting for bed temp to cool down to {filter_disable_bed_temp}°C to turn filter off..."
			TEMPERATURE_WAIT SENSOR=heater_bed MINIMUM=0 MAXIMUM={filter_disable_bed_temp}
			SET_FAN_SPEED FAN=filter SPEED=0
			_LED_CHAMBER_FILTER_OFF
		{% endif %}

	{% endif %}


[delayed_gcode _CHAMBER_FILTER_OFF_TIMER]
gcode:
	DEBUG_ECHO PREFIX="_CHAMBER_FILTER_OFF_TIMER" MSG="executed"

	# turn filter fan off
	SET_FAN_SPEED FAN=filter SPEED=0

	# echo
	RATOS_ECHO PREFIX="CHAMBER_FILTER" MSG="Chamber filter turned off!"

	# visual feedback
	_LED_CHAMBER_FILTER_OFF


[gcode_macro _CHAMBER_FILTER_SANITY_CHECK]
gcode:
	# config
	{% set chamber_filter_enable = true if printer["gcode_macro RatOS"].chamber_filter_enable|default(true)|lower == 'true' else false %}
	{% set filter_disable_period = printer["gcode_macro RatOS"].chamber_filter_disable_period|default(0)|int %}
	{% set filter_disable_bed_temp = printer["gcode_macro RatOS"].chamber_filter_disable_bed_temp|default(0)|int %}

	# chamber filter sanity check if feature is enabled and fan is configured
	{% if chamber_filter_enable and printer["fan_generic filter"] is defined %}

		{% if filter_disable_bed_temp > 0 and filter_disable_period > 0 %}
			_LEARN_MORE_CHAMBER_FILTER
			{action_respond_info("Wrong chamber filter options configured! Set 'filter_disable_bed_temp' or 'filter_disable_period' variable, not both.")}
		{% endif %}

		{% if filter_disable_bed_temp == 0 and filter_disable_period == 0 %}
			_LEARN_MORE_CHAMBER_FILTER
			{action_respond_info("Wrong chamber filter options configured! Set 'filter_disable_bed_temp' or 'filter_disable_period' variable.")}
		{% endif %}

	{% endif %}
