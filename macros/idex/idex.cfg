# WARNING: DO NOT EDIT THIS FILE
# To override settings from this file, you can copy and paste the relevant
# sections into your printer.cfg and change it there.

#####
# CONFIGURATION VARIABLES
#####
[gcode_macro RatOS]
variable_auto_center_subject: False   # EXPERIMENTAL: auto center printed parts in x axis for idex copy and mirror mode

#####
# IDEX macros
#####
[gcode_macro IDEX_SINGLE]
gcode:
	_IDEX_REMAP_TOOLHEADS ENABLE=False
	_IDEX_SINGLE

[gcode_macro _IDEX_SINGLE]
gcode:
	# Handle toolhead settings
	CACHE_TOOLHEAD_SETTINGS KEY="idex_single"
	SET_MACRO_TRAVEL_SETTINGS

	# parameters
	{% set init = params.INIT|default(0)|int %}
	{% set new_x = params.X|default(-1)|int %}

	# config
	{% set idex_mode = printer["dual_carriage"].carriage_1|lower %}
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed * 60 %}
	{% set default_toolhead = printer["gcode_macro RatOS"].default_toolhead|default(0)|int %}
	{% set printable_x_max = printer["gcode_macro RatOS"].printable_x_max|float %}
	{% set printable_y_max = printer["gcode_macro RatOS"].printable_y_max|float %}
	{% set center_x = printable_x_max / 2 %}
	{% set act_t = 1 if idex_mode == 'primary' else 0 %}
	{% set parking_position_act_t = printer["gcode_macro T%s" % (0 if act_t==1 else 1)].parking_position|float %}
	{% set parking_position_default_t = printer["gcode_macro T%s" % (0 if default_toolhead==1 else 1)].parking_position|float %}

	DEBUG_ECHO PREFIX="IDEX_SINGLE" MSG="init: {init}, new_x: {new_x}, idex_mode: {idex_mode}, printable_x_max: {printable_x_max}, center_x: {center_x}, act_t: {act_t}"

	{% if idex_mode == "copy" or idex_mode == "mirror" or init == 1 %}

		# reset gcode offset
		{% if 'x' in printer.toolhead.homed_axes %}
			{% if idex_mode == "copy" or idex_mode == "mirror" %}
				DEBUG_ECHO PREFIX="IDEX_SINGLE" MSG="reset gcode offset"
				G1 X{center_x} F{(speed)}
				SET_GCODE_OFFSET X_ADJUST={center_x / 2} MOVE=0
			{% endif %}
		{% endif %}

		# activate default carriage
		DEBUG_ECHO PREFIX="IDEX_SINGLE" MSG="activate default carriage"
		SET_DUAL_CARRIAGE CARRIAGE={default_toolhead} MODE=PRIMARY

		# set toolheads
		{% if 'x' in printer.toolhead.homed_axes %}
			DEBUG_ECHO PREFIX="IDEX_SINGLE" MSG="set toolheads"

			# make sure gantry is in the printable area
			{% if printer.toolhead.position.y|float > printable_y_max %}
				G1 Y{printable_y_max} F{speed}
			{% endif %}

			G90         # absolute positioning

			DEBUG_ECHO PREFIX="IDEX_SINGLE" MSG="move secondary toolhead to parking position."
			SET_DUAL_CARRIAGE CARRIAGE={0 if default_toolhead==1 else 1}
			G1 X{parking_position_default_t} F{speed}   

			DEBUG_ECHO PREFIX="IDEX_SINGLE" MSG="move default toolhead to its new position."
			SET_DUAL_CARRIAGE CARRIAGE={default_toolhead}
			{% if new_x == -1 %}
				{% set new_x = center_x %}
			{% endif %}
			G1 X{new_x} F{speed}   

			M400         # wait for movements
		{% else %}
			DEBUG_ECHO PREFIX="IDEX_SINGLE" MSG="X Axis not homed."
			# select primary toolhead
			SET_DUAL_CARRIAGE CARRIAGE={default_toolhead}
		{% endif %}

		# set extruder motion queue
		DEBUG_ECHO PREFIX="IDEX_SINGLE" MSG="set extruder motion queue."
		ACTIVATE_EXTRUDER EXTRUDER=extruder{'' if default_toolhead==0 else default_toolhead}
		SYNC_EXTRUDER_MOTION EXTRUDER=extruder MOTION_QUEUE=extruder
		SYNC_EXTRUDER_MOTION EXTRUDER=extruder1 MOTION_QUEUE=extruder1

		# set toolhead offset
		DEBUG_ECHO PREFIX="IDEX_SINGLE" MSG="set toolhead offset."
		_SET_TOOLHEAD_OFFSET T={default_toolhead}

		# set input shaper
		DEBUG_ECHO PREFIX="IDEX_SINGLE" MSG="set input shaper."
		{% set shaper_x_freq = printer["gcode_macro RatOS"].shaper_x_freq %}
		{% set shaper_y_freq = printer["gcode_macro RatOS"].shaper_y_freq %}
		{% set shaper_x_type = printer["gcode_macro RatOS"].shaper_x_type %}
		{% set shaper_y_type = printer["gcode_macro RatOS"].shaper_y_type %}
		SET_INPUT_SHAPER SHAPER_FREQ_X={(shaper_x_freq[default_toolhead]|float)} SHAPER_FREQ_Y={(shaper_y_freq[default_toolhead]|float)} SHAPER_TYPE_X={(shaper_x_type[default_toolhead]|lower)} SHAPER_TYPE_Y={(shaper_y_type[default_toolhead]|lower)}

		# update Frontend
		DEBUG_ECHO PREFIX="IDEX_SINGLE" MSG="update Frontend."
		SET_GCODE_VARIABLE MACRO=T0 VARIABLE=active VALUE={True if default_toolhead==0 else False}
		SET_GCODE_VARIABLE MACRO=T1 VARIABLE=active VALUE={True if default_toolhead==1 else False}
	{% else %}
		{% if "xyz" in printer.toolhead.homed_axes %}
			DEBUG_ECHO PREFIX="IDEX_SINGLE" MSG="move secondary toolhead to parking position"

			# make sure gantry is in the printable area
			{% if printer.toolhead.position.y|float > printable_y_max %}
				G1 Y{printable_y_max} F{speed}
			{% endif %}

			SET_DUAL_CARRIAGE CARRIAGE={0 if act_t==1 else 1}
			G1 X{parking_position_act_t} F{speed}   
			SET_DUAL_CARRIAGE CARRIAGE={act_t}
		{% else %}
			DEBUG_ECHO PREFIX="IDEX_SINGLE" MSG="Axis not homed."
			# select primary toolhead
			SET_DUAL_CARRIAGE CARRIAGE={default_toolhead}
		{% endif %}
	{% endif %}

	# Handle toolhead settings
	RESTORE_TOOLHEAD_SETTINGS KEY="idex_single"

[gcode_macro IDEX_COPY]
gcode:
	_IDEX_COPY

[gcode_macro _IDEX_COPY]
gcode:
	# Handle toolhead settings
	CACHE_TOOLHEAD_SETTINGS KEY="idex_copy"
	SET_MACRO_TRAVEL_SETTINGS

	# parameters
  {% set y = params.Y|default(-1)|int %}
	{% set dance = params.DANCE|default(1)|int %}

	# config
	{% set idex_mode = printer["dual_carriage"].carriage_1|lower %}
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed * 60 %}
	{% set default_toolhead = printer["gcode_macro RatOS"].default_toolhead|default(0)|int %}
	{% set printable_x_max = printer["gcode_macro RatOS"].printable_x_max|float %}
	{% set center_x = printable_x_max / 2 %}

	DEBUG_ECHO PREFIX="IDEX_COPY" MSG="idex_mode: {idex_mode}, printable_x_max: {printable_x_max}, center_x: {center_x}, dance: {dance}, y: {y}"

	# set idex mode
	{% if "xyz" in printer.toolhead.homed_axes %}
		{% if idex_mode != "copy" %}
			{% if idex_mode == "mirror" %}
				{% if y>=0 %}
					G1 X{center_x} Y{y} F{(speed)}
				{% else %}
					G1 X{center_x} F{(speed)}
				{% endif %}
			{% endif %}

			{% if idex_mode == "primary" or idex_mode == "inactive" %}
				_IDEX_SET_TOOLHEADS
			{% endif %}

			# set extruder motion queue
			ACTIVATE_EXTRUDER EXTRUDER='extruder'
			SYNC_EXTRUDER_MOTION EXTRUDER=extruder MOTION_QUEUE=extruder
			SYNC_EXTRUDER_MOTION EXTRUDER=extruder1 MOTION_QUEUE=extruder

			# activate copy mode
			SET_DUAL_CARRIAGE CARRIAGE=1 MODE=COPY

			# sync pressure advance
			{% if idex_mode != "mirror" %}
				SET_PRESSURE_ADVANCE
			{% endif %}

			# set toolhead offset
			{% if idex_mode != "mirror" %}
				SET_GCODE_OFFSET X_ADJUST=-{center_x / 2} MOVE=0
			{% else %}
				_SET_TOOLHEAD_OFFSET T={default_toolhead}
			{% endif %}
	
			# dance
			{% if dance == 1 %}
				G1 X{center_x} F{(speed)}
				G1 X{center_x - 30} F{(speed)}
				G1 X{center_x + 30} F{(speed)}
				G1 X{center_x} F{(speed)}
			{% endif %}

			# set input shaper
			{% set shaper_x_freq = printer["gcode_macro RatOS"].shaper_x_freq %}
			{% set shaper_y_freq = printer["gcode_macro RatOS"].shaper_y_freq %}
			{% set shaper_x_type = printer["gcode_macro RatOS"].shaper_x_type %}
			{% set shaper_y_type = printer["gcode_macro RatOS"].shaper_y_type %}
			SET_INPUT_SHAPER SHAPER_FREQ_X={(shaper_x_freq[2]|float)} SHAPER_FREQ_Y={(shaper_y_freq[2]|float)} SHAPER_TYPE_X={(shaper_x_type[2]|lower)} SHAPER_TYPE_Y={(shaper_y_type[2]|lower)}

			# update Frontend
			SET_GCODE_VARIABLE MACRO=T0 VARIABLE=active VALUE=True
			SET_GCODE_VARIABLE MACRO=T1 VARIABLE=active VALUE=True

		{% endif %}
	{% else %}
		{action_respond_info("Printer not homed")}
	{% endif %} 

	# Handle toolhead settings
	RESTORE_TOOLHEAD_SETTINGS KEY="idex_copy"

[gcode_macro IDEX_MIRROR]
gcode:
	_IDEX_MIRROR

[gcode_macro _IDEX_MIRROR]
gcode:
	# Handle toolhead settings
	CACHE_TOOLHEAD_SETTINGS KEY="idex_mirror"
	SET_MACRO_TRAVEL_SETTINGS

	# parameters
	{% set dance = params.DANCE|default(1)|int %}
	{% set priming = params.PRIMING|default(0)|int %}

	# config
	{% set idex_mode = printer["dual_carriage"].carriage_1|lower %}
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed * 60 %}
	{% set default_toolhead = printer["gcode_macro RatOS"].default_toolhead|default(0)|int %}
	{% set printable_x_max = printer["gcode_macro RatOS"].printable_x_max|float %}
	{% set center_x = printable_x_max / 2 %}

	DEBUG_ECHO PREFIX="IDEX_MIRROR" MSG="idex_mode: {idex_mode}, printable_x_max: {printable_x_max}, center_x: {center_x}, dance: {dance}"

	# set idex mode
	{% if "xyz" in printer.toolhead.homed_axes %}
		{% if idex_mode != "mirror" %}

			{% if idex_mode == "copy" %}
				G1 X{center_x} F{(speed)}
			{% endif %}

			{% if idex_mode == "primary" or idex_mode == "inactive" %}
				_IDEX_SET_TOOLHEADS MIRROR_PRIMING={params.PRIMING}
			{% endif %}

			# set extruder motion queue
			ACTIVATE_EXTRUDER EXTRUDER='extruder'
			SYNC_EXTRUDER_MOTION EXTRUDER=extruder MOTION_QUEUE=extruder
			SYNC_EXTRUDER_MOTION EXTRUDER=extruder1 MOTION_QUEUE=extruder

			# activate mirror mode
			SET_DUAL_CARRIAGE CARRIAGE=1 MODE=MIRROR

			# sync pressure advance
			{% if idex_mode != "copy" %}
				SET_PRESSURE_ADVANCE
			{% endif %}

			# set toolhead offset
			{% if idex_mode != "copy" %}
				SET_GCODE_OFFSET X_ADJUST=-{center_x / 2} MOVE=0
			{% else %}
				_SET_TOOLHEAD_OFFSET T={default_toolhead}
			{% endif %}

			# dance
			{% if dance and not priming %}
				G1 X{center_x} F{(speed)}
				G1 X{center_x - 30} F{(speed)}
				G1 X{center_x + 30} F{(speed)}
				G1 X{center_x} F{(speed)}
			{% endif %}

			# set input shaper
			{% set shaper_x_freq = printer["gcode_macro RatOS"].shaper_x_freq %}
			{% set shaper_y_freq = printer["gcode_macro RatOS"].shaper_y_freq %}
			{% set shaper_x_type = printer["gcode_macro RatOS"].shaper_x_type %}
			{% set shaper_y_type = printer["gcode_macro RatOS"].shaper_y_type %}
			SET_INPUT_SHAPER SHAPER_FREQ_X={(shaper_x_freq[3]|float)} SHAPER_FREQ_Y={(shaper_y_freq[3]|float)} SHAPER_TYPE_X={(shaper_x_type[3]|lower)} SHAPER_TYPE_Y={(shaper_y_type[3]|lower)}

			# update Frontend
			SET_GCODE_VARIABLE MACRO=T0 VARIABLE=active VALUE=True
			SET_GCODE_VARIABLE MACRO=T1 VARIABLE=active VALUE=True

		{% endif %}
	{% else %}
		{action_respond_info("Printer not homed")}
	{% endif %} 

	# Handle toolhead settings
	RESTORE_TOOLHEAD_SETTINGS KEY="idex_mirror"

[gcode_macro _IDEX_SET_TOOLHEADS]
gcode:
	# Handle toolhead settings
	CACHE_TOOLHEAD_SETTINGS KEY="idex_set_toolheads"
	SET_MACRO_TRAVEL_SETTINGS

	# parameters
	{% set mirror_priming = params.MIRROR_PRIMING|default(0)|int %}

	# idex mode
	{% set idex_mode = printer["dual_carriage"].carriage_1|lower %}
	{% set act_t = 1 if idex_mode == 'primary' else 0 %}

	# config
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed * 60 %}
	{% set default_toolhead = printer["gcode_macro RatOS"].default_toolhead|default(0)|int %}
	{% set parking_position_inactive_t = printer["gcode_macro T%s" % (0 if act_t==1 else 1)].parking_position|float %}
	{% set parking_position_t0 = printer["gcode_macro T0"].parking_position|float %}
	{% set parking_position_t1 = printer["gcode_macro T1"].parking_position|float %}
	{% set printable_x_max = printer["gcode_macro RatOS"].printable_x_max|float %}
	{% set printable_y_max = printer["gcode_macro RatOS"].printable_y_max|float %}
	{% set center_x = printable_x_max / 2 %}

	DEBUG_ECHO PREFIX="_IDEX_SET_TOOLHEADS" MSG="idex_mode: {idex_mode}, act_t: {act_t}, center_x: {center_x}, mirror_priming: {mirror_priming}"

	# reset toolhead offset
	{% if act_t != default_toolhead %}
		_SET_TOOLHEAD_OFFSET T={default_toolhead} MOVE=1
	{% endif %}

	{% if mirror_priming %}

		# Bring toolheads to the same distance to the printable area so
		# they are correctly mirrored through the center of the build plate 
		{% if parking_position_t0|abs < parking_position_t1 - printable_x_max %}
			SET_DUAL_CARRIAGE CARRIAGE=1 MODE=PRIMARY
			G1 X{printable_x_max + parking_position_t0|abs} F{(speed)}
		{% else %}
			SET_DUAL_CARRIAGE CARRIAGE=0 MODE=PRIMARY
			G1 X{0 - (parking_position_t1 - printable_x_max)} F{(speed)}
		{% endif %}

	{% else %}

		# make sure gantry is in the printable area
		{% if printer.toolhead.position.y|float > printable_y_max %}
			G1 Y{printable_y_max} F{speed}
		{% endif %}

		# make sure inactive toolhead is in its parking position
		SET_DUAL_CARRIAGE CARRIAGE={0 if act_t==1 else 1} MODE=PRIMARY
		G1 X{parking_position_inactive_t} F{(speed)}

		# move dc toolhead to its new position in case its already active
		{% if act_t==1 %}
			SET_DUAL_CARRIAGE CARRIAGE=1 MODE=PRIMARY
			G1 X{center_x / 2 + center_x} F{(speed)}
		{% endif %}

		# move x toolhead to its new position
		SET_DUAL_CARRIAGE CARRIAGE=0 MODE=PRIMARY
		G1 X{center_x / 2} F{(speed)}

		# move dc toolhead to its new position
		SET_DUAL_CARRIAGE CARRIAGE=1 MODE=PRIMARY
		G1 X{center_x / 2 + center_x} F{(speed)}

	{% endif %}

	# Handle toolhead settings
	RESTORE_TOOLHEAD_SETTINGS KEY="idex_set_toolheads"

[gcode_macro IDEX_PARK]
gcode:
	# ensures compatibility with users of helges mainsail fork
	PARK_TOOLHEAD

[gcode_macro PARK_TOOLHEAD]
gcode:
	# get IDEX mode
	{% set idex_mode = 'none' %}
	{% if printer["dual_carriage"] is defined %}
		{% set idex_mode = printer["dual_carriage"].carriage_1|lower %}
	{% endif %}
	{% set act_t = 1 if idex_mode=='primary' else 0 %}

	DEBUG_ECHO PREFIX="PARK_TOOLHEAD" MSG="Parking T{act_t}.."

	# config 
	{% set speed = printer["gcode_macro RatOS"].toolchange_travel_speed * 60 %}
	{% set z_speed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	{% set acceleration = printer["gcode_macro RatOS"].toolchange_travel_accel %}
	{% set parking_position_act_t = printer["gcode_macro T%s" % act_t].parking_position|float %}
	{% set parking_position_inact_t = printer["gcode_macro T%s" % (0 if act_t==1 else 1)].parking_position|float %}
	{% set printable_y_min = printer["gcode_macro RatOS"].printable_y_min|float %}
	{% set printable_y_max = printer["gcode_macro RatOS"].printable_y_max|float %}

	# park toolhead
	{% if idex_mode != "copy" and idex_mode != "mirror" and 'xy' in printer.toolhead.homed_axes %}

		# make sure gantry is in the printable area
		{% if printer.toolhead.position.y|float > printable_y_max %}
			G1 Y{printable_y_max} F{speed}
		{% elif printer.toolhead.position.y|float < printable_y_min %}
			G1 Y{printable_y_min} F{speed}
		{% endif %}

		SAVE_GCODE_STATE NAME=_PARK_TOOLHEAD
		G90           # absolute positioning
		SET_VELOCITY_LIMIT ACCEL={acceleration} MINIMUM_CRUISE_RATIO=0.5

		# move both toolheads to parking position
		G1 X{parking_position_act_t} F{speed}                     
		SET_DUAL_CARRIAGE CARRIAGE={0 if act_t==1 else 1}
		G1 X{parking_position_inact_t} F{speed}    
		SET_DUAL_CARRIAGE CARRIAGE={act_t}

		SET_VELOCITY_LIMIT ACCEL={printer.toolhead.max_accel} MINIMUM_CRUISE_RATIO=0.5
		M400          # wait for movements
		RESTORE_GCODE_STATE NAME=_PARK_TOOLHEAD 

	{% endif %}

#####
# IDEX spool joining 
#####
[gcode_macro JOIN_SPOOLS]
gcode:
	# parameters
	{% set spools = params.SPOOLS|default("") %}

	{% if spools == "" %}
		_IDEX_JOIN_SPOOLS ENABLE=false
	{% else %}
		{% if spools != "0,1" and spools != "1,0" %}
			RATOS_ECHO MSG="Wrong spool configuration!"
			RATOS_ECHO MSG="Join Spools = JOIN_SPOOLS SPOOLS=0,1"
			RATOS_ECHO MSG="Deactivate = JOIN_SPOOLS SPOOLS="
		{% else %}
			{% if spools == "0,1" or spools == "1,0" %}
				_IDEX_JOIN_SPOOLS ENABLE=true
			{% else %}
				_IDEX_JOIN_SPOOLS ENABLE=false
			{% endif %}
		{% endif %}
	{% endif %}

[gcode_macro _IDEX_JOIN_SPOOLS]
variable_enabled: False   # internal use only. Do not touch!
gcode:
	# parameters
	{% set enable = true if params.ENABLE|default(false)|lower == 'true' else false %}

	# config
	{% set idex_mode = printer["dual_carriage"].carriage_1|lower %}

	# store setting
	SET_GCODE_VARIABLE MACRO=_IDEX_JOIN_SPOOLS VARIABLE=enabled VALUE=False
	{% if idex_mode != "copy" and idex_mode != "mirror" %}
		{% if enable %}
			{% set has_t0_toolhead_filament_sensor = true if printer["filament_switch_sensor toolhead_filament_sensor_t0"] is defined else false %}
			{% set has_t1_toolhead_filament_sensor = true if printer["filament_switch_sensor toolhead_filament_sensor_t0"] is defined else false %}
			{% set has_t0_bowden_filament_sensor = true if printer["filament_switch_sensor bowden_filament_sensor_t0"] is defined else false %}
			{% set has_t1_bowden_filament_sensor = true if printer["filament_switch_sensor bowden_filament_sensor_t1"] is defined else false %}
			{% if (has_t0_toolhead_filament_sensor and has_t1_toolhead_filament_sensor) or (has_t0_bowden_filament_sensor and has_t1_bowden_filament_sensor) %}
				SET_GCODE_VARIABLE MACRO=_IDEX_JOIN_SPOOLS VARIABLE=enabled VALUE=True
				RATOS_ECHO MSG="Spool joining enabled for the next print!"
			{% else %}
				RATOS_ECHO MSG="Can not enable spool joining! No filament sensors found."
			{% endif %}
		{% else %}
			RATOS_ECHO MSG="Spool joining deactivated!"
		{% endif %}
	{% else %}
		RATOS_ECHO MSG="Spool joining is not possible in copy and mirror mode!"
	{% endif %}

[gcode_macro _JOIN_SPOOL]
gcode:
	# parameter
	{% set old_toolhead = params.TOOLHEAD|int %}
	{% set new_toolhead = 0 if old_toolhead == 1 else 1 %}

	# Config
	{% set speed = printer["gcode_macro RatOS"].toolchange_travel_speed|float * 60 %}
	{% set purge_after_load = printer["gcode_macro T%s" % new_toolhead].purge_after_load|float %}

	DEBUG_ECHO PREFIX="_JOIN_SPOOL" MSG="toolhead={new_toolhead}"

	{% set has_filament = true %}
	{% set has_new_toolhead_filament_sensor = true if printer["filament_switch_sensor toolhead_filament_sensor_t%s" % new_toolhead] is defined else false %}
	{% set has_new_bowden_filament_sensor = true if printer["filament_switch_sensor bowden_filament_sensor_t%s" % new_toolhead] is defined else false %}
	{% if has_new_toolhead_filament_sensor %}
		{% if printer["filament_switch_sensor toolhead_filament_sensor_t%s" % new_toolhead].enabled|lower == "true" %}
			{% if printer["filament_switch_sensor toolhead_filament_sensor_t%s" % new_toolhead].filament_detected|lower != "true" %}
				{% set has_filament = false %}
			{% endif %}
		{% else %}
			{% set has_filament = false %}
		{% endif %}
	{% endif %}
	{% if has_new_bowden_filament_sensor %}
		{% if printer["filament_switch_sensor bowden_filament_sensor_t%s" % new_toolhead].enabled|lower == "true" %}
			{% if printer["filament_switch_sensor bowden_filament_sensor_t%s" % new_toolhead].filament_detected|lower != "true" %}
				{% set has_filament = false %}
			{% endif %}
		{% else %}
			{% set has_filament = false %}
		{% endif %}
	{% endif %}

	{% if has_filament %}
		RATOS_ECHO MSG="Joining spools! Please wait for extruder to heat up...."

		# override paused toolhead variable
		SET_GCODE_VARIABLE MACRO=PAUSE VARIABLE=idex_toolhead VALUE={new_toolhead}

		# deactivate old toolhead
		_DEACTIVATE_TOOLHEAD TOOLHEAD={old_toolhead}

		# wait for new extruder to heat up
		{% if printer["gcode_macro _ON_LAYER_CHANGE"].layer_number|int < 2 %}
			{% set extruder_temp = printer["gcode_macro START_PRINT"].extruder_first_layer_temp[new_toolhead]|float %}
		{% else %}
			{% set extruder_temp = printer["gcode_macro START_PRINT"].extruder_other_layer_temp[new_toolhead]|float %}
		{% endif %}
		TEMPERATURE_WAIT SENSOR={'extruder' if new_toolhead == 0 else 'extruder1'} MINIMUM={extruder_temp}  MAXIMUM={extruder_temp + 5}

		# preextrude filament
		{% if purge_after_load > 0 %}

			# activate new toolhead and extruder
			SET_DUAL_CARRIAGE CARRIAGE={new_toolhead} MODE=PRIMARY
			ACTIVATE_EXTRUDER EXTRUDER=extruder{'' if new_toolhead == 0 else new_toolhead}

			# preextrude
			_MOVE_TO_LOADING_POSITION TOOLHEAD={new_toolhead}
			_PURGE_FILAMENT TOOLHEAD={new_toolhead} E={purge_after_load}
			_CLEANING_MOVE TOOLHEAD={new_toolhead}

			# reactivate old toolhead to make sure the toolshift in the resume macro works as expected
			SET_DUAL_CARRIAGE CARRIAGE={old_toolhead} MODE=PRIMARY
			ACTIVATE_EXTRUDER EXTRUDER=extruder{'' if old_toolhead == 0 else old_toolhead}

		{% endif %}

		# resume print
		RESUME TOOLHEAD={new_toolhead}

		# deactivate join spool feature since there is no filament anymore in the old toolhead
		_IDEX_JOIN_SPOOLS ENABLE=false

	{% else %}
		{ action_raise_error("Spool join failed! No filament found or filament sensor is disabled.") }
	{% endif %}

#####
# IDEX toolhead remapping 
#####
[gcode_macro REMAP_TOOLHEADS]
gcode:
	# parameters
	{% set toolheads = params.TOOLHEADS|default("") %}

	{% if toolheads == "" %}
		_IDEX_REMAP_TOOLHEADS ENABLE=false
	{% else %}
		{% if toolheads != "0,1" and toolheads != "1,0" %}
			RATOS_ECHO MSG="Wrong toolhead configuration!"
			RATOS_ECHO MSG="Remap = REMAP_TOOLHEADS TOOLHEADS=0,1"
			RATOS_ECHO MSG="Deactivate = REMAP_TOOLHEADS TOOLHEADS="
		{% else %}
			{% if toolheads == "0,1" or toolheads == "1,0" %}
				_IDEX_REMAP_TOOLHEADS ENABLE=true
				_IDEX_SINGLE
			{% else %}
				_IDEX_REMAP_TOOLHEADS ENABLE=false
			{% endif %}
		{% endif %}
	{% endif %}

[gcode_macro _IDEX_REMAP_TOOLHEADS]
variable_enabled: False   # internal use only. Do not touch!
gcode:
	# parameters
	{% set enable = true if params.ENABLE|default(false)|lower == 'true' else false %}

	# config
	{% set idex_mode = printer["dual_carriage"].carriage_1|lower %}

	# store setting
	{% if not enable or (idex_mode != "copy" and idex_mode != "mirror") %}
		{% if enable %}
			RATOS_ECHO MSG="Toolhead remapping enabled for the next print!"
		{% else %}
			RATOS_ECHO MSG="Toolhead remapping deactivated!"
		{% endif %}
		SET_GCODE_VARIABLE MACRO=_IDEX_REMAP_TOOLHEADS VARIABLE=enabled VALUE={enable}
	{% else %}
		RATOS_ECHO MSG="Toolhead remapping not possible in copy and mirror mode!"
		SET_GCODE_VARIABLE MACRO=_IDEX_REMAP_TOOLHEADS VARIABLE=enabled VALUE=False
	{% endif %}
