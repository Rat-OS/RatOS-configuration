#####
# TOOLHEAD SELECTION
####
[gcode_macro _SELECT_TOOL]
gcode:
	{% if params.T is defined %}
		{% set idex_mode = '' %}
		{% if printer["dual_carriage"] is defined %}
			{% set idex_mode = printer["dual_carriage"].carriage_1|lower %}
			{% if "xyz" not in printer.toolhead.homed_axes and (idex_mode == "copy" or idex_mode == "mirror") %}
				_IDEX_SINGLE
				{% set idex_mode = 'reset' %}
			{% endif %}
		{% endif %}
		{% if idex_mode != "copy" and idex_mode != "mirror" %}
			{% set act_t = 1 if idex_mode == 'primary' else 0 %}
			{% set new_t = params.T|int %}
			{% set act_extruder = 'extruder%s' % ('' if new_t == 0 else new_t) %}  
			{% if new_t != act_t or printer.toolhead.extruder != act_extruder or idex_mode == 'reset' %} 

				RATOS_ECHO PREFIX="IDEX" MSG="Selecting T{new_t}.."

				# reset any speed override from the purge tower
				M220 S100

				# parameters
				{% set new_x = params.X|default(-1)|float %}
				{% set new_y = params.Y|default(-1)|float %}
				{% set z_hop = params.Z|default(0.0)|float %}
				{% set toolshift = true if params.TOOLSHIFT|default(1)|int == 1 else false %}

				# deactivate toolshifting if printer is not homed
				{% if "xyz" not in printer.toolhead.homed_axes %}
					{% set toolshift = false %}
				{% endif %}

				# swap part cooling fans
				{% set fan_speed = printer["fan_generic part_fan_t%s" % act_t].speed %}
				{% set sync_fans = true if printer["gcode_macro RatOS"].toolchange_sync_fans|default(false)|lower == 'true' else false %}
				{% if fan_speed > 0 %}
					SET_FAN_SPEED FAN=part_fan_t0 SPEED={fan_speed if (new_t == 0 or sync_fans) else 0}
					SET_FAN_SPEED FAN=part_fan_t1 SPEED={fan_speed if (new_t == 1 or sync_fans) else 0}
					# Update core Klipper's fan speed to the fan speed of the active toolhead
					# Only do this if you have a sacrificial [fan] section
					M106.1 S{fan_speed}
				{% endif %}

				# change toolhead
				_TOOLCHANGE T={new_t} X={new_x} Y={new_y} TOOLSHIFT={toolshift} Z_HOP={z_hop}

				# set input shaper
				{% set shaper_x_freq = printer["gcode_macro RatOS"].shaper_x_freq %}
				{% set shaper_y_freq = printer["gcode_macro RatOS"].shaper_y_freq %}
				{% set shaper_x_type = printer["gcode_macro RatOS"].shaper_x_type %}
				{% set shaper_y_type = printer["gcode_macro RatOS"].shaper_y_type %}
				SET_INPUT_SHAPER SHAPER_FREQ_X={(shaper_x_freq[new_t]|float)} SHAPER_FREQ_Y={(shaper_y_freq[new_t]|float)} SHAPER_TYPE_X={(shaper_x_type[new_t]|lower)} SHAPER_TYPE_Y={(shaper_y_type[new_t]|lower)}

				# update mainsail UI
				SET_GCODE_VARIABLE MACRO=T0 VARIABLE=active VALUE={True if new_t == 0 else False}
				SET_GCODE_VARIABLE MACRO=T1 VARIABLE=active VALUE={True if new_t == 1 else False}

				# this is a very basic sanity check for the klipper idex_mode.py bug 
				# a randomly apearing bug in idex_mode.py leads to switched modes for the dual carriage state
				{% if 'x' in printer.toolhead.homed_axes %}
					{% set sanity_check_idex_mode = printer["dual_carriage"].carriage_1|lower %}
					{% if new_t == 0 %}
						{% if printer.toolhead.extruder == 'extruder' %}
							{% if sanity_check_idex_mode == 'primary' %}
								{ action_emergency_stop("Switched states detected in idex_mode.py. Please restart the host controller.") }
							{% endif %}
						{% endif %}
					{% elif new_t == 1 %}
						{% if printer.toolhead.extruder == 'extruder1' %}
							{% if sanity_check_idex_mode == 'inactive' %}
								{ action_emergency_stop("Switched states detected in idex_mode.py. Please restart the host controller.") }
							{% endif %}
						{% endif %}
					{% endif %}
				{% endif %}

				# absolute positioning
				G90

			{% endif %}
		{% endif %}
	{% endif %}

[gcode_macro _TOOLCHANGE]
gcode:
	# parameters 
	{% set new_t = params.T|default(-1)|int %}
	{% set new_x = params.X|default(-1.0)|float %}
	{% set new_y = params.Y|default(-1.0)|float %}
	{% set z_hop = params.Z_HOP|default(0.0)|float %}
	{% set toolshift = true if params.TOOLSHIFT|default(true)|lower == 'true' else false %}
	{% set is_printing_gcode = true if printer["gcode_macro START_PRINT"].is_printing_gcode|default(true)|lower == 'true' else false %}

	DEBUG_ECHO PREFIX="_TOOLCHANGE" MSG="T={new_t} X={new_x} Y={new_y} IS_PRINTING_GCODE={is_printing_gcode} TOOLSHIFT={toolshift} Z_HOP={z_hop}"

	# ratos variables file
	{% set svv = printer.save_variables.variables %}

	# config
	{% set speed = printer["gcode_macro RatOS"].toolchange_travel_speed * 60 %}
	{% set z_speed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	{% set config_zhop = printer["gcode_macro RatOS"].toolchange_zhop|default(1.0)|float %}
	{% set center_x = printer.configfile.settings.stepper_x.position_max|float / 2 %}
	{% set acceleration = printer["gcode_macro RatOS"].toolchange_travel_accel %}
	{% set parking_position = printer["gcode_macro RatOS"].parking_position %}
	{% set speed = printer["gcode_macro RatOS"].toolchange_travel_speed * 60 %}
	{% set idex_mode = printer["dual_carriage"].carriage_1|lower %}
	{% set act_t = 1 if idex_mode == 'primary' else 0 %}

	# change toolhead
	{% if not is_printing_gcode and not toolshift %}

		DEBUG_ECHO PREFIX="_TOOLCHANGE" MSG="Changing tool to T{new_t} without retracting/extruding or moving the toolheads except for parking."

		# park toolhead
		{% if "xyz" in printer.toolhead.homed_axes %}
			G1 X{parking_position[act_t]} F{speed}
		{% endif %}

		# activate new carriage and offset
		SET_DUAL_CARRIAGE CARRIAGE={new_t} MODE=PRIMARY

		# set offset
		_SET_TOOLHEAD_OFFSET T={new_t} MOVE={1 if "xyz" in printer.toolhead.homed_axes else 0}

		# activate new extruder
		ACTIVATE_EXTRUDER EXTRUDER=extruder{'' if new_t == 0 else new_t}

	{% else %}
		# absolute positioning
		G90

		# set toolchange acceleration
		{% set max_accel = printer.toolhead.max_accel|float %}
		{% set square_corner_velocity = printer.toolhead.square_corner_velocity|float %}
		SET_VELOCITY_LIMIT ACCEL={acceleration} ACCEL_TO_DECEL={acceleration} SQUARE_CORNER_VELOCITY=20

		# manual tool switching, bring new tool to the printable center
		{% if not is_printing_gcode and toolshift and new_x < 0 and new_y < 0 %}
			{% set new_x = center_x %}
			{% set new_y = printer.gcode_move.gcode_position.y|float %}
		{% endif %}

		{% if new_x < 0 or new_y < 0 %}     
			# park the active toolhead and activate new toolhead without moving it

			# z-hop before parking
			DEBUG_ECHO PREFIX="_TOOLCHANGE" MSG="No new X or Y position given, parking the active toolhead and activating the new toolhead without moving it."
			_ZHOP_BEFORE_TOOLCHANGE Z_HOP={z_hop + config_zhop} T={new_t} 

			# park toolhead
			{% if "x" in printer.toolhead.homed_axes %}
				G1 X{parking_position[act_t]} F{speed}
			{% endif %}

			# # extrude after parking
			{% if is_printing_gcode %}
				_EXTRUDE T={new_t}
			{% endif %}

			# activate new carriage and offset
			SET_DUAL_CARRIAGE CARRIAGE={new_t}
			_SET_TOOLHEAD_OFFSET T={new_t} MOVE={1 if "xyz" in printer.toolhead.homed_axes else 0}

			# activate new extruder
			ACTIVATE_EXTRUDER EXTRUDER=extruder{'' if new_t == 0 else new_t}

		{% else %}
			{% if "xyz" not in printer.toolhead.homed_axes %}
				# printer is not homed

				# activate the new carriage and offset
				SET_DUAL_CARRIAGE CARRIAGE={new_t}
				_SET_TOOLHEAD_OFFSET T={new_t}

				# activate new extruder
				ACTIVATE_EXTRUDER EXTRUDER=extruder{'' if new_t == 0 else new_t}

			{% else %}
				# shift the toolheads

				# get current z-position
				{% set gcode_z = printer.gcode_move.gcode_position.z|float %}
				{% set toolhead_z = printer.toolhead.position.z|float %}

				{% if new_t == 0 %}
					# get values
					{% set t0_act_x = parking_position[0]|float %}
					{% set t1_act_x = printer.toolhead.position.x|float %}
					{% set t0_new_x = new_x %}
					{% set t1_new_x = parking_position[1]|float %}
					{% set t0_distance = t0_new_x - t0_act_x %}
					{% set t1_distance = t1_new_x - t1_act_x %}

					# calculate needed z-hop
					{% set calc_z_hop = z_hop + config_zhop %}

					# z-hop before toolchange
					DEBUG_ECHO PREFIX="_TOOLCHANGE" MSG="Shifting to T0."
					_ZHOP_BEFORE_TOOLCHANGE Z_HOP={calc_z_hop} T={new_t} SYNC=1 

					# make sure T0 is in its correct parking position
					SET_DUAL_CARRIAGE CARRIAGE=0 MODE=PRIMARY
					G1 X{t0_act_x} F{speed}

					{% if t0_distance >= t1_distance %}
						# copy move
						SET_DUAL_CARRIAGE CARRIAGE=1 MODE=COPY
						G1 X{t0_act_x + (t1_new_x - t1_act_x)} Y{new_y + svv.idex_yoffset} F{speed}

						# move T0 
						SET_DUAL_CARRIAGE CARRIAGE=0 MODE=PRIMARY
						G1 X{t0_new_x + svv.idex_xoffset} F{speed}

					{% elif t0_distance < t1_distance %}
						# copy move  
						SET_DUAL_CARRIAGE CARRIAGE=1 MODE=COPY
						G1 X{t0_new_x + svv.idex_xoffset} Y{new_y + svv.idex_yoffset} F{speed}

						# park T1
						SET_DUAL_CARRIAGE CARRIAGE=1 MODE=PRIMARY
						G1 X{t1_new_x} F{speed}

						# move T0 
						SET_DUAL_CARRIAGE CARRIAGE=0 MODE=PRIMARY
						G1 X{t0_new_x + svv.idex_xoffset} F{speed}

					{% endif %}

					# Offset move
					{% if svv.idex_applied_offset != 0 %}
						SET_GCODE_OFFSET X_ADJUST={(svv.idex_xoffset)} Y_ADJUST={(svv.idex_yoffset)} MOVE=0 SPEED={speed}
						G1 X{t0_new_x} Y{new_y} F{speed}
						SET_GCODE_OFFSET Z_ADJUST={(svv.idex_zoffset)} MOVE=1 SPEED={z_speed}
						SAVE_VARIABLE VARIABLE=idex_applied_offset VALUE=0
						RATOS_ECHO PREFIX="IDEX" MSG="Toolhead offset applied for T0: X={svv.idex_xoffset} Y={svv.idex_yoffset} Z={svv.idex_zoffset}"
					{% endif %}

					# calculate needed z-drop
					{% set calc_z_drop = z_hop + config_zhop %}

					# z-drop after toolchange
					_ZDROP_AFTER_TOOLCHANGE Z_DROP={calc_z_drop} T={new_t} SYNC=1 

				{% elif new_t == 1 %}
					# get values
					{% set t0_act_x = printer.toolhead.position.x|float %}
					{% set t1_act_x = parking_position[1]|float %}
					{% set t0_new_x = parking_position[0]|float %}
					{% set t1_new_x = new_x %}
					{% set t0_distance = t0_act_x - t0_new_x %}
					{% set t1_distance = t1_act_x - t1_new_x %}

					# calculate needed z-hop
					{% set calc_z_hop = z_hop + config_zhop %}

					# z-hop before toolchange
					DEBUG_ECHO PREFIX="_TOOLCHANGE" MSG="Shifting to T1."
					_ZHOP_BEFORE_TOOLCHANGE Z_HOP={calc_z_hop} T={new_t} SYNC=1 

					# make sure T1 is in its correct parking position
					SET_DUAL_CARRIAGE CARRIAGE=1 MODE=PRIMARY
					G1 X{t1_act_x} F{speed}

					{% if t0_distance >= t1_distance %}
						# copy move
						SET_DUAL_CARRIAGE CARRIAGE=1 MODE=COPY
						G1 X{t0_act_x - (t1_act_x - t1_new_x) - svv.idex_xoffset} Y{new_y - svv.idex_yoffset} F{speed}

						# park T0
						SET_DUAL_CARRIAGE CARRIAGE=0 MODE=PRIMARY
						G1 X{t0_new_x - svv.idex_xoffset} F{speed}

						# move T1
						SET_DUAL_CARRIAGE CARRIAGE=1 MODE=PRIMARY

					{% elif t0_distance < t1_distance %}
						# copy move
						SET_DUAL_CARRIAGE CARRIAGE=1 MODE=COPY
						G1 X{t0_new_x} Y{new_y - svv.idex_yoffset} F{speed}

						# move T1
						SET_DUAL_CARRIAGE CARRIAGE=1 MODE=PRIMARY
						G1 X{t1_new_x - svv.idex_xoffset} F{speed}

					{% endif %}

					# offset move
					{% if svv.idex_applied_offset != 1 %}
						SET_GCODE_OFFSET X_ADJUST={(0-svv.idex_xoffset)} Y_ADJUST={(0-svv.idex_yoffset)} MOVE=0 SPEED={speed}
						G1 X{t1_new_x} Y{new_y} F{speed}
						SET_GCODE_OFFSET Z_ADJUST={(0-svv.idex_zoffset)} MOVE=1 SPEED={z_speed}
						SAVE_VARIABLE VARIABLE=idex_applied_offset VALUE=1
						RATOS_ECHO PREFIX="IDEX" MSG="Toolhead offset applied for T1: X={(0-svv.idex_xoffset)} Y={(0-svv.idex_yoffset)} Z={(0-svv.idex_zoffset)}"
					{% endif %}

					# calculate needed z-drop
					{% set calc_z_drop = z_hop + config_zhop %}

					# z-drop after toolchange
					_ZDROP_AFTER_TOOLCHANGE Z_DROP={calc_z_drop} T={new_t} SYNC=1 

				{% endif %}

				# activate new extruder
				ACTIVATE_EXTRUDER EXTRUDER=extruder{'' if new_t == 0 else new_t}

			{% endif %}
		{% endif %}

		# reset acceleration
		SET_VELOCITY_LIMIT ACCEL={max_accel} ACCEL_TO_DECEL={(max_accel / 2)} SQUARE_CORNER_VELOCITY={square_corner_velocity}

	{% endif %}

[gcode_macro _ZHOP_BEFORE_TOOLCHANGE]
gcode:
	# parameters 
	{% set t = params.T|int %}
	{% set sync = params.SYNC|default(0)|int %}
	{% set z_hop = params.Z_HOP|default(0.0)|float %}
	{% set is_printing_gcode = true if printer["gcode_macro START_PRINT"].is_printing_gcode|default(true)|lower == 'true' else false %}

	# config
	{% set speed = printer["gcode_macro RatOS"].toolchange_zspeed|default(15)|float %}
	{% set feedrate = printer["gcode_macro RatOS"].toolchange_feedrate %}
	{% set combined_zhop = printer["gcode_macro RatOS"].toolchange_combined_zhop|default(0)|int %}
	{% set both_toolheads = true if printer["gcode_macro START_PRINT"].both_toolheads|default(true)|lower == 'true' else false %}
	{% set e = printer["gcode_macro RatOS"].toolchange_retraction %}

	DEBUG_ECHO PREFIX="_ZHOP_BEFORE_TOOLCHANGE" MSG="T={t} BOTH_TOOLHEADS={both_toolheads} SYNC={sync} IS_PRINTING_GCODE={is_printing_gcode} Z_HOP={z_hop}"

	G91                             # relative positioning
	M82                             # absolute extrusion
	G92 E0                          # reset extrusion distance

	# snyc extruders
	{% if sync == 1 and t == 0 and is_printing_gcode and both_toolheads %}
		{% if printer['extruder'].can_extrude|lower == 'true' and printer['extruder1'].can_extrude|lower == 'true' %}
			DEBUG_ECHO PREFIX="_ZHOP_BEFORE_TOOLCHANGE" MSG="SYNC_EXTRUDER_MOTION EXTRUDER=extruder MOTION_QUEUE=extruder1"
			SYNC_EXTRUDER_MOTION EXTRUDER=extruder MOTION_QUEUE=extruder1
		{% endif %}
	{% elif sync == 1 and t == 1 and is_printing_gcode and both_toolheads %}
		{% if printer['extruder'].can_extrude|lower == 'true' and printer['extruder1'].can_extrude|lower == 'true' %}
			DEBUG_ECHO PREFIX="_ZHOP_BEFORE_TOOLCHANGE" MSG="SYNC_EXTRUDER_MOTION EXTRUDER=extruder1 MOTION_QUEUE=extruder"
			SYNC_EXTRUDER_MOTION EXTRUDER=extruder1 MOTION_QUEUE=extruder
		{% endif %}
	{% endif %}

	# z-hop
	{% if combined_zhop == 1 and is_printing_gcode %}
		DEBUG_ECHO PREFIX="_ZHOP_BEFORE_TOOLCHANGE" MSG="COMBINED_ZHOP G1 Z+{z_hop} E-{e[t]} F{speed * 60}"
		G1 Z+{z_hop} E-{e[t]} F{speed * 60}
	{% else %}
		DEBUG_ECHO PREFIX="_ZHOP_BEFORE_TOOLCHANGE" MSG="ZHOP G1 Z+{z_hop} F{speed * 60}"
		G1 Z+{z_hop} F{speed * 60}
		{% if is_printing_gcode %}
			DEBUG_ECHO PREFIX="_ZHOP_BEFORE_TOOLCHANGE" MSG="RETRACT G1 E-{e[t]} F{feedrate[t]}"
			G1 E-{e[t]} F{feedrate[t]}
		{% endif %}
	{% endif %}

	_WAIT_FOR_MOVEMENTS							# wait for movements if configured

	# unsync extruder
	{% if sync == 1 and t == 0 and is_printing_gcode and both_toolheads %}
		{% if printer['extruder'].can_extrude|lower == 'true' and printer['extruder1'].can_extrude|lower == 'true' %}
			DEBUG_ECHO PREFIX="_ZHOP_BEFORE_TOOLCHANGE" MSG="UNSYNC_EXTRUDER_MOTION EXTRUDER=extruder MOTION_QUEUE=extruder"
			SYNC_EXTRUDER_MOTION EXTRUDER=extruder MOTION_QUEUE=extruder
		{% endif %}
	{% elif sync == 1 and t == 1 and is_printing_gcode and both_toolheads %}
		{% if printer['extruder'].can_extrude|lower == 'true' and printer['extruder1'].can_extrude|lower == 'true' %}
			DEBUG_ECHO PREFIX="_ZHOP_BEFORE_TOOLCHANGE" MSG="UNSYNC_EXTRUDER_MOTION EXTRUDER=extruder1 MOTION_QUEUE=extruder1"
			SYNC_EXTRUDER_MOTION EXTRUDER=extruder1 MOTION_QUEUE=extruder1
		{% endif %}
	{% endif %}

	G90                             # absolute positioning
	G92 E0                          # reset extrusion distance
	_SET_EXTRUSION_MODE							# Set extrusion mode based on user configuration

[gcode_macro _ZDROP_AFTER_TOOLCHANGE]
gcode:
	# parameters 
	{% set t = params.T|int %}
	{% set sync = params.SYNC|default(0)|int %}
	{% set z_drop = params.Z_DROP|default(0.0)|float %}
	{% set is_printing_gcode = true if printer["gcode_macro START_PRINT"].is_printing_gcode|default(true)|lower == 'true' else false %}
	
	# config
	{% set speed = printer["gcode_macro RatOS"].toolchange_zspeed|default(15)|float %}
	{% set feedrate = printer["gcode_macro RatOS"].toolchange_feedrate %}
	{% set combined_zhop = printer["gcode_macro RatOS"].toolchange_combined_zhop|default(0)|int %}
	{% set both_toolheads = true if printer["gcode_macro START_PRINT"].both_toolheads|default(true)|lower == 'true' else false %}
	{% set e = printer["gcode_macro RatOS"].toolchange_extrusion %}

	DEBUG_ECHO PREFIX="_ZDROP_AFTER_TOOLCHANGE" MSG="T={t} BOTH_TOOLHEADS={both_toolheads} SYNC={sync} IS_PRINTING_GCODE={is_printing_gcode} Z_DROP={z_drop}"

	G91                             # relative positioning
	M82                             # absolute extrusion
	G92 E0                          # reset extrusion distance

	# snyc extruders
	{% if sync == 1 and t == 0 and is_printing_gcode and both_toolheads %}
		{% if printer['extruder'].can_extrude|lower == 'true' and printer['extruder1'].can_extrude|lower == 'true' %}
			DEBUG_ECHO PREFIX="_ZDROP_AFTER_TOOLCHANGE" MSG="SYNC_EXTRUDER_MOTION EXTRUDER=extruder MOTION_QUEUE=extruder1"
			SYNC_EXTRUDER_MOTION EXTRUDER=extruder MOTION_QUEUE=extruder1
		{% endif %}
	{% elif sync == 1 and t == 1 and is_printing_gcode and both_toolheads %}
		{% if printer['extruder'].can_extrude|lower == 'true' and printer['extruder1'].can_extrude|lower == 'true' %}
			DEBUG_ECHO PREFIX="_ZDROP_AFTER_TOOLCHANGE" MSG="SYNC_EXTRUDER_MOTION EXTRUDER=extruder1 MOTION_QUEUE=extruder"
			SYNC_EXTRUDER_MOTION EXTRUDER=extruder1 MOTION_QUEUE=extruder
		{% endif %}
	{% endif %}

	# z-drop
	{% if combined_zhop == 1 and is_printing_gcode %}
		DEBUG_ECHO PREFIX="_ZDROP_AFTER_TOOLCHANGE" MSG="COMBINED_ZDROP G1 Z-{z_drop} E{e[t]} F{speed * 60}"
		G1 Z-{z_drop} E{e[t]} F{speed * 60}
	{% else %}
		DEBUG_ECHO PREFIX="_ZDROP_AFTER_TOOLCHANGE" MSG="ZDROP G1 Z-{z_drop} F{speed * 60}"
		G1 Z-{z_drop} F{speed * 60}
		{% if is_printing_gcode %}
			DEBUG_ECHO PREFIX="_ZDROP_AFTER_TOOLCHANGE" MSG="EXTRUDE G1 E{e[t]} F{feedrate[t]}"
			G1 E{e[t]} F{feedrate[t]}
		{% endif %}
	{% endif %}

	_WAIT_FOR_MOVEMENTS							# wait for movements if configured

	# unsync extruder
	{% if sync == 1 and t == 0 and is_printing_gcode and both_toolheads %}
		{% if printer['extruder'].can_extrude|lower == 'true' and printer['extruder1'].can_extrude|lower == 'true' %}
			DEBUG_ECHO PREFIX="_ZDROP_AFTER_TOOLCHANGE" MSG="UNSYNC_EXTRUDER_MOTION EXTRUDER=extruder MOTION_QUEUE=extruder"
			SYNC_EXTRUDER_MOTION EXTRUDER=extruder MOTION_QUEUE=extruder
		{% endif %}
	{% elif sync == 1 and t == 1 and is_printing_gcode and both_toolheads %}
		{% if printer['extruder'].can_extrude|lower == 'true' and printer['extruder1'].can_extrude|lower == 'true' %}
			DEBUG_ECHO PREFIX="_ZDROP_AFTER_TOOLCHANGE" MSG="UNSYNC_EXTRUDER_MOTION EXTRUDER=extruder1 MOTION_QUEUE=extruder1"
			SYNC_EXTRUDER_MOTION EXTRUDER=extruder1 MOTION_QUEUE=extruder1
		{% endif %}
	{% endif %}

	G90                             # absolute positioning
	G92 E0                          # reset extrusion distance
	_SET_EXTRUSION_MODE							# Set extrusion mode based on user configuration

[gcode_macro _EXTRUDE]
gcode:
	# parameters 
	{% set t = params.T|int %}

	# config
	{% set e = printer["gcode_macro RatOS"].toolchange_extrusion %}
	{% set feedrate = printer["gcode_macro RatOS"].toolchange_feedrate %}

	DEBUG_ECHO PREFIX="_EXTRUDE" MSG="G1 E{e[t]} F{feedrate[t] * 60}"

	# extrude
	G91                             # relative positioning
	M82                             # absolute extrusion
	G92 E0                          # reset extrusion distance
	G1 E{e[t]} F{feedrate[t] * 60}  # retract
	G90                             # absolute positioning
	G92 E0                          # reset extrusion distance
	_WAIT_FOR_MOVEMENTS							# wait for movements if configured
	_SET_EXTRUSION_MODE							# Set extrusion mode based on user configuration

#####
# TOOLHEAD HELPER
####

[delayed_gcode _INIT_TOOLHEADS]
initial_duration: 0.1
gcode:
	{% if printer["dual_carriage"] is defined %}

		# config 
		{% set default_toolhead = printer["gcode_macro RatOS"].default_toolhead|int %}

		# ratos variables file
		{% set svv = printer.save_variables.variables %}
		SAVE_VARIABLE VARIABLE=idex_applied_offset VALUE={default_toolhead}

		# activate IDEX default
		_IDEX_SINGLE INIT=1

		# this is brutal, but better than colliding toolheads
		# inverted hybrid core-xy bugfix sanity check
		{% set inverted = False %}
		{% if printer.configfile.settings.ratos_hybrid_corexy is defined and printer.configfile.settings.ratos_hybrid_corexy.inverted is defined %}
			{% if printer.configfile.settings.ratos_hybrid_corexy.inverted|lower == 'true' %}
				{% set inverted = True %}
			{% endif %}
		{% endif %}
		{% if inverted == False %}
			{ action_emergency_stop("ratos_hybrid_corexy NOT INVERTED! Inverted hybrid core-xy bugfix not detected.") }
		{% endif %}

		# toolhead offsets sanity check
		{% if svv.idex_zoffset>0 %}
			{ action_emergency_stop("Wrong physical toolhead z-offset detected! The secondary toolheads nozzle must be higher then the nozzle from the primary toolhead.") }
		{% endif %}
		{% if default_toolhead == 0 and svv.idex_xoffset>0 %}
			{ action_emergency_stop("Wrong physical toolhead x-offset detected! The secondary toolhead T1 x-offset must be negative.") }
		{% endif %}
		{% if default_toolhead == 1 and svv.idex_xoffset<0 %}
			{ action_emergency_stop("Wrong physical toolhead x-offset detected! The secondary toolhead T0 x-offset must be positive.") }
		{% endif %}

		# dual carriage safe distance sanity check
		{% if printer.configfile.settings.dual_carriage.safe_distance is defined %}
			{% if printer.configfile.settings.dual_carriage.safe_distance|float < 50 %}
				{ action_emergency_stop("Dual carriage safe_distance seems to be too low!") }
			{% endif %}
		{% else %}
			{ action_emergency_stop("Dual carriage safe_distance not defined!") }
		{% endif %}

		# stepper min max position sanity check
		{% if printer.configfile.settings.dual_carriage.position_min|float < 0 %}
			{ action_emergency_stop("dual_carriage position_min too low, set it to 0!") }
		{% endif %}
		{% if printer.configfile.settings.stepper_x.position_max|float != 200 %}
			{% if printer.configfile.settings.stepper_x.position_max|float != 300 %}
				{% if printer.configfile.settings.stepper_x.position_max|float != 400 %}
					{% if printer.configfile.settings.stepper_x.position_max|float != 500 %}
						{ action_emergency_stop("stepper_x position_max seems to be wrong, set it to your max print width!") }
					{% endif %}
				{% endif %}
			{% endif %}
		{% endif %}

	{% endif %}

[gcode_macro _SET_TOOLHEAD_OFFSET]
gcode:
	# parameters 
	{% set t = params.T|int %}  
	{% set move = params.MOVE|default(0)|int %}  

	# echo
	DEBUG_ECHO PREFIX="_SET_TOOLHEAD_OFFSET" MSG="T={t} MOVE={move}"

	# ratos variables file
	{% set svv = printer.save_variables.variables %}

	# config 
	{% set speed = printer["gcode_macro RatOS"].toolchange_travel_speed * 60 %}
	{% set z_speed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}

	# set offset
	{% if "xyz" not in printer.toolhead.homed_axes %}
		{% set move = 0 %}  
	{% endif %}
	{% if svv.idex_applied_offset != t %}
		{% if t != printer["gcode_macro RatOS"].default_toolhead|int %}
			DEBUG_ECHO PREFIX="_SET_TOOLHEAD_OFFSET" MSG="SET_GCODE_OFFSET X_ADJUST={(svv.idex_xoffset)} Y_ADJUST={(svv.idex_yoffset)} MOVE={move} SPEED={speed}"
			SET_GCODE_OFFSET X_ADJUST={(svv.idex_xoffset)} Y_ADJUST={(svv.idex_yoffset)} MOVE={move} SPEED={speed}
			DEBUG_ECHO PREFIX="_SET_TOOLHEAD_OFFSET" MSG="SET_GCODE_OFFSET Z_ADJUST={(svv.idex_zoffset)} MOVE={move} SPEED={z_speed}"
			SET_GCODE_OFFSET Z_ADJUST={(svv.idex_zoffset)} MOVE={move} SPEED={z_speed}
		{% else %}
			DEBUG_ECHO PREFIX="_SET_TOOLHEAD_OFFSET" MSG="SET_GCODE_OFFSET X_ADJUST={(0-svv.idex_xoffset)} Y_ADJUST={(0-svv.idex_yoffset)} MOVE={move} SPEED={speed}"
			SET_GCODE_OFFSET X_ADJUST={(0-svv.idex_xoffset)} Y_ADJUST={(0-svv.idex_yoffset)} MOVE={move} SPEED={speed}
			DEBUG_ECHO PREFIX="_SET_TOOLHEAD_OFFSET" MSG="SET_GCODE_OFFSET Z_ADJUST={(0-svv.idex_zoffset)} MOVE={move} SPEED={z_speed}"
			SET_GCODE_OFFSET Z_ADJUST={(0-svv.idex_zoffset)} MOVE={move} SPEED={z_speed}
		{% endif %}
		RATOS_ECHO PREFIX="IDEX" MSG="Toolhead offset applied for T{t}"
		SAVE_VARIABLE VARIABLE=idex_applied_offset VALUE={t}
	{% endif %}

[gcode_macro TOOLCHANGE_CONFIG]
gcode:
	SET_GCODE_VARIABLE MACRO=RatOS VARIABLE=toolchange_travel_speed VALUE={params.SPEED|default(300)}
	SET_GCODE_VARIABLE MACRO=RatOS VARIABLE=toolchange_travel_accel VALUE={params.ACCEL|default(5000)}
	SET_GCODE_VARIABLE MACRO=RatOS VARIABLE=toolchange_retraction VALUE={params.RETRACT|default('[0.8,0.8]')}
	SET_GCODE_VARIABLE MACRO=RatOS VARIABLE=toolchange_extrusion VALUE={params.EXTRUDE|default('[0.8,0.8]')}
	SET_GCODE_VARIABLE MACRO=RatOS VARIABLE=toolchange_feedrate VALUE={params.FEEDRATE|default('[7200,7200]')}
	SET_GCODE_VARIABLE MACRO=RatOS VARIABLE=toolchange_m400 VALUE={true if params.M400|default(0)|int == 1 else false}
	SET_GCODE_VARIABLE MACRO=RatOS VARIABLE=toolchange_zhop VALUE={params.ZHOP|default(1.0)|float}
	SET_GCODE_VARIABLE MACRO=RatOS VARIABLE=toolchange_combined_zhop VALUE={params.COMBINED_ZHOP|default(0)|int}
	SET_GCODE_VARIABLE MACRO=RatOS VARIABLE=toolchange_sync_fans VALUE={true if params.SYNC_FANS|default(0)|int == 1 else false}

# this fixes a superslicer issue
# only the currently active extruders temp got changed after the first layer.
# call this from the slicers change layer custom gcode 
[gcode_macro _LAYER_CHANGE]
variable_t: 0
variable_layer_number: 1                  
variable_extruder_other_layer_temp: 0     
variable_extruder_other_layer_temp_1: 0   
gcode:
	{% if printer["gcode_macro _LAYER_CHANGE"].layer_number is defined %}
		{% set layer_number = printer["gcode_macro _LAYER_CHANGE"].layer_number|int %}
		{% if printer["gcode_macro _LAYER_CHANGE"].extruder_other_layer_temp is defined %}
			{% if layer_number == 2 %}
				{% set t = printer["gcode_macro _LAYER_CHANGE"].t|int %}
				{% set both_toolheads = true if printer["gcode_macro START_PRINT"].both_toolheads|default(true)|lower == 'true' else false %}
				{% set extruder_other_layer_temp = printer["gcode_macro _LAYER_CHANGE"].extruder_other_layer_temp|float %}
				{% set extruder_other_layer_temp_1 = printer["gcode_macro _LAYER_CHANGE"].extruder_other_layer_temp_1|float %}
				{% if t == 0 or both_toolheads %}
					M104 S{extruder_other_layer_temp} T0
				{% endif %}
				{% if t == 1 or both_toolheads %}
					M104 S{extruder_other_layer_temp_1} T1
				{% endif %}
			{% endif %}
		{% endif %}
		SET_GCODE_VARIABLE MACRO=_LAYER_CHANGE VARIABLE=layer_number VALUE={layer_number + 1}
	{% endif %}

#####
# REUSEABLES
####

[gcode_macro _WAIT_FOR_MOVEMENTS]
gcode:
	# config
	{% set m400 = true if printer["gcode_macro RatOS"].toolchange_m400|default(true)|lower == 'true' else false %}

	# wait for movements
	{% if m400 %}
		DEBUG_ECHO PREFIX="_WAIT_FOR_MOVEMENTS" MSG="M400"
		M400
	{% endif %}
