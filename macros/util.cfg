# WARNING: DO NOT EDIT THIS FILE
# To override settings from this file, you can copy and paste the relevant
# sections into your printer.cfg and change it there.

#####
# CONFIGURATION VARIABLES
#####

[gcode_macro ECHO_T_VARS]
description: Echo Toolhead variables to the console.
gcode:
	{% set t = params.T|default(0) %}
	RATOS_ECHO MSG="T{t} Variables"
	{% for var, value in printer["gcode_macro T%s" % t].items() %}
		{action_respond_info(var ~ ": " ~ value)}
	{% endfor %}

[gcode_macro ECHO_RATOS_VARS]
description: Echo RatOS variables to the console.
gcode:
	{% for var, value in printer["gcode_macro RatOS"].items() %}
		{action_respond_info(var ~ ": " ~ value)}
	{% endfor %}
	
[gcode_macro RatOS]
description: RatOS variable storage macro, will echo variables to the console when run.
variable_relative_extrusion: False                # True|False = enable relative extrusion mode
variable_force_absolute_position: False           # True|False = force absolute positioning before the print starts
variable_preheat_extruder: True                   # True|False = enable preheating for inductive probes
variable_preheat_extruder_temp: 150               # int = the preheating nozzle temperature
variable_macro_travel_speed: 150                  # int = xy macro travel move speed  
variable_macro_travel_accel: 2000                 # int = xy macro travel move acceleration
variable_macro_z_speed: 15                        # int = z macro travel move speed
variable_bed_margin_x: [0, 0]                     # [float, float] = left and right bed margin
variable_bed_margin_y: [0, 0]                     # [float, float] = front and back bed margin
variable_printable_x_min: 0                       # internal use only. Do not touch!
variable_printable_x_max: 0                       # internal use only. Do not touch!
variable_printable_y_min: 0                       # internal use only. Do not touch!
variable_printable_y_max: 0                       # internal use only. Do not touch!
variable_end_print_motors_off: True               # True|False = Keeps the motors for none IDEX printer on after a print ends
variable_status_color_ok: "00FF00"                # internal use only. Do not touch!
variable_status_color_error: "FF0000"             # internal use only. Do not touch!
variable_status_color_unknown: "FFFF00"           # internal use only. Do not touch!
variable_end_print_retract_filament: 10           # float = total amount of retraction in mm after a print ends
gcode:
	ECHO_RATOS_VARS


[delayed_gcode RATOS_INIT]
initial_duration: 0.1
gcode:
	_LED_STANDBY
	CALCULATE_PRINTABLE_AREA
	INITIAL_FRONTEND_UPDATE
	_CHAMBER_FILTER_SANITY_CHECK


[delayed_gcode RATOS_LOGO]
initial_duration: 2
gcode:
	HELLO_RATOS


[gcode_macro INITIAL_FRONTEND_UPDATE]
gcode:
	# config
	{% set color_ok = printer["gcode_macro RatOS"].status_color_ok|string %}
	{% set color_error = printer["gcode_macro RatOS"].status_color_error|string %}
	{% set color_unknown = printer["gcode_macro RatOS"].status_color_unknown|string %}

	# set default status
	SET_GCODE_VARIABLE MACRO=T0 VARIABLE=color VALUE='"{color_unknown}"'
	{% if printer["dual_carriage"] is defined %}
		SET_GCODE_VARIABLE MACRO=T1 VARIABLE=color VALUE='"{color_unknown}"'
	{% endif %}

	# filament detection in case user has filament sensors configured
	{% set t0_sensor = "undefined" %}
	{% if printer["filament_switch_sensor toolhead_filament_sensor_t0"] is defined %}
		{% if printer["filament_switch_sensor toolhead_filament_sensor_t0"].enabled|lower == "true" %}
			{% if printer["filament_switch_sensor toolhead_filament_sensor_t0"].filament_detected|lower == "true" %}
				{% set t0_sensor = "detected" %}
			{% else %}
				{% set t0_sensor = "empty" %}
			{% endif %}
		{% else %}
			{% set t0_sensor = "disabled" %}
		{% endif %}
	{% endif %}
	{% set t1_sensor = "undefined" %}
	{% if printer["dual_carriage"] is defined and printer["filament_switch_sensor toolhead_filament_sensor_t1"] is defined %}
		{% if printer["filament_switch_sensor toolhead_filament_sensor_t1"].enabled|lower == "true" %}
			{% if printer["filament_switch_sensor toolhead_filament_sensor_t1"].filament_detected|lower == "true" %}
				{% set t1_sensor = "detected" %}
			{% else %}
				{% set t1_sensor = "empty" %}
			{% endif %}
		{% else %}
			{% set t1_sensor = "disabled" %}
		{% endif %}
	{% endif %}

	# set loaded filaments, needed for the frontend. takes filament sensors into account
	{% set svv = printer.save_variables.variables %}
	{% if svv.t0_filament is defined and printer["gcode_macro T0"] is defined %}
		{% if printer["gcode_macro T0"].filament_name is defined and printer["gcode_macro T0"].filament_type is defined and printer["gcode_macro T0"].filament_temp is defined %}
			{% if t0_sensor != "empty" %}
				{% set t0_filament_type = svv.t0_filament[0]|default('')|string %}
				{% set t0_filament_name = svv.t0_filament[1]|default('')|string %}
				{% set t0_filament_temp = svv.t0_filament[2]|default(0)|float %}
				{% if t0_filament_name != '' and t0_filament_type != '' and t0_filament_temp > 0 %}
					SET_GCODE_VARIABLE MACRO=T0 VARIABLE=color VALUE='"{color_ok}"'
					SET_GCODE_VARIABLE MACRO=T0 VARIABLE=filament_name VALUE='"{t0_filament_name}"'
					SET_GCODE_VARIABLE MACRO=T0 VARIABLE=filament_type VALUE='"{t0_filament_type}"'
					SET_GCODE_VARIABLE MACRO=T0 VARIABLE=filament_temp VALUE={t0_filament_temp}
				{% endif %}
			{% else %}
				SAVE_VARIABLE VARIABLE=t0_filament VALUE="('""', '""', 0)"
				SET_GCODE_VARIABLE MACRO=T0 VARIABLE=filament_name VALUE='""'
				SET_GCODE_VARIABLE MACRO=T0 VARIABLE=filament_type VALUE='""'
				SET_GCODE_VARIABLE MACRO=T0 VARIABLE=filament_temp VALUE=0
			{% endif %}
		{% endif %}
	{% endif %}
	{% if svv.t1_filament is defined and printer["gcode_macro T1"] is defined %}
		{% if printer["gcode_macro T1"].filament_name is defined and printer["gcode_macro T1"].filament_type is defined and printer["gcode_macro T1"].filament_temp is defined %}
			{% if t1_sensor != "empty" %}
				{% set t1_filament_type = svv.t1_filament[0]|default('')|string %}
				{% set t1_filament_name = svv.t1_filament[1]|default('')|string %}
				{% set t1_filament_temp = svv.t1_filament[2]|default(0)|float %}
				{% if t1_filament_name != '' and t1_filament_type != '' and t1_filament_temp > 0 %}
					SET_GCODE_VARIABLE MACRO=T1 VARIABLE=color VALUE='"{color_ok}"'
					SET_GCODE_VARIABLE MACRO=T1 VARIABLE=filament_name VALUE='"{t1_filament_name}"'
					SET_GCODE_VARIABLE MACRO=T1 VARIABLE=filament_type VALUE='"{t1_filament_type}"'
					SET_GCODE_VARIABLE MACRO=T1 VARIABLE=filament_temp VALUE={t1_filament_temp}
				{% endif %}
			{% else %}
				SAVE_VARIABLE VARIABLE=t1_filament VALUE="('""', '""', 0)"
				SET_GCODE_VARIABLE MACRO=T1 VARIABLE=filament_name VALUE='""'
				SET_GCODE_VARIABLE MACRO=T1 VARIABLE=filament_type VALUE='""'
				SET_GCODE_VARIABLE MACRO=T1 VARIABLE=filament_temp VALUE=0
			{% endif %}
		{% endif %}
	{% endif %}


[gcode_macro CALCULATE_PRINTABLE_AREA]
gcode:
	{% set bed_margin_x = printer["gcode_macro RatOS"].bed_margin_x %}
	{% set bed_margin_y = printer["gcode_macro RatOS"].bed_margin_y %}

	# original code
	# with T1 as default toolhead it returns 240 instead of 300
	{% set tool = 0 if printer["gcode_macro T0"] is not defined or printer["gcode_macro T0"].active else 1 %}
	{% set max_x = printer.toolhead.axis_maximum.x if printer["dual_carriage"] is defined and tool == 0 else printer.toolhead.axis_maximum.x - bed_margin_x[1] %}

	# Temporary bugfix bc original code deosnt work if T1 is default toolhead
	{% if printer["dual_carriage"] is defined %}
		# printer.toolhead.axis_maximum.x returns here always 300 on my idex
		# we are calling this macro when klipper starts
		# so this printer["gcode_macro T0"].active is always false
		# doesnt make any sense at all to use it here		 
		{% set max_x = printer.toolhead.axis_maximum.x %}
	{% endif %}

	DEBUG_ECHO PREFIX="CALCULATE_PRINTABLE_AREA" MSG="printer.toolhead.axis_maximum.x {printer.toolhead.axis_maximum.x}"

	{% set max_y = printer.toolhead.axis_maximum.y - bed_margin_y[1]%}
	SET_GCODE_VARIABLE MACRO=RatOS VARIABLE=printable_x_max VALUE={max_x}
	SET_GCODE_VARIABLE MACRO=RatOS VARIABLE=printable_y_max VALUE={max_y}
	DEBUG_ECHO PREFIX="CALCULATE_PRINTABLE_AREA" MSG="Printable area calculated: X: 0,{max_x} Y: 0,{max_y}"


[gcode_macro CACHE_TOOLHEAD_SETTINGS]
variable_cache: {"global": {"accel": 1000, "ratio": 0.5, "speed": 50, "scv": 5}}
gcode:
	# cache toolhead settings
	{% set key = "global" %}
	{% if params.KEY is defined %}
		{% set key = params.KEY %}
	{% endif %}
	{% set dummy = cache.__setitem__(key, {"accel": printer.toolhead.max_accel, "ratio": printer.toolhead.minimum_cruise_ratio, "speed": printer.toolhead.max_velocity, "scv": printer.toolhead.square_corner_velocity}) %}
	SET_GCODE_VARIABLE MACRO=CACHE_TOOLHEAD_SETTINGS VARIABLE=cache VALUE="{cache | pprint | replace("\n", "") | replace("\"", "\\\"")}"
	DEBUG_ECHO PREFIX="CACHE_TOOLHEAD_SETTINGS" MSG="Toolhead settings cached for {key}. {printer.toolhead.max_accel} accel, {printer.toolhead.minimum_cruise_ratio} ratio, {printer.toolhead.max_velocity} velocity, {printer.toolhead.square_corner_velocity} scv."


[gcode_macro RESTORE_TOOLHEAD_SETTINGS]
gcode:
	# restore toolhead settings
	{% set key = "global" %}
	{% if params.KEY is defined %}
		{% set key = params.KEY %}
	{% endif %}
	{% set values = printer["gcode_macro CACHE_TOOLHEAD_SETTINGS"].cache.__getitem__(key) %}
	{% if values is not defined or values == 'None' %}
		{ action_raise_error("RESTORE_TOOLHEAD_SETTINGS: Toolhead settings not cached for key '" ~ key ~ "'.") }
	{% endif %}
	SET_VELOCITY_LIMIT ACCEL={values.accel} MINIMUM_CRUISE_RATIO={values.ratio} VELOCITY={values.speed} SQUARE_CORNER_VELOCITY={values.scv}
	DEBUG_ECHO PREFIX="RESTORE_TOOLHEAD_SETTINGS" MSG="Toolhead settings restored. {values.accel} accel, {values.ratio} ratio, {values.speed} velocity, {values.scv} scv."


[gcode_macro SET_MACRO_TRAVEL_SETTINGS]
gcode:
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	{% set accel = printer["gcode_macro RatOS"].macro_travel_accel %}
	SET_VELOCITY_LIMIT ACCEL={accel} MINIMUM_CRUISE_RATIO=0.5 VELOCITY={speed} SQUARE_CORNER_VELOCITY={5}
	DEBUG_ECHO PREFIX="SET_MACRO_TRAVEL_SETTINGS" MSG="Macro travel settings set. {accel} accel, {speed} velocity"


[gcode_macro SET_CENTER_KINEMATIC_POSITION]
description: FOR DEBUGGING PURPOSES ONLY. Sets the internal printer kinematic state to the center of all axes regardless of actual physical position.
gcode:
	# config
	{% set printable_x_max = printer["gcode_macro RatOS"].printable_x_max|float %}
	{% set printable_y_max = printer["gcode_macro RatOS"].printable_y_max|float %}

	RATOS_ECHO MSG="WARNING: ONLY USE SET_CENTER_KINEMATIC_POSITION FOR DEBUGGING PURPOSES. YOU'RE OVERRIDING THE INTERNAL POSITIONING STATE OF THE PRINTER. PROCEED WITH CAUTION AND DO A PROPER G28 WHEN DONE."
	SET_GCODE_VARIABLE MACRO=MAYBE_HOME VARIABLE=is_kinematic_position_overriden VALUE=True
	{% if printer["dual_carriage"] is not defined %}
		# DEFAULT
		SET_KINEMATIC_POSITION X={printable_x_max / 2} Y={printable_y_max / 2} Z={printer.toolhead.axis_maximum.z / 2}
	{% else %}
		# IDEX
		IDEX_SET_CENTER_KINEMATIC_POSITION
	{% endif %}


[gcode_macro IDEX_SET_CENTER_KINEMATIC_POSITION]
description: FOR DEBUGGING PURPOSES ONLY. Sets the internal printer kinematic state to the center of all axes regardless of actual physical position.
gcode:
	# config
	{% set printable_x_max = printer["gcode_macro RatOS"].printable_x_max|float %}
	{% set printable_y_max = printer["gcode_macro RatOS"].printable_y_max|float %}

	RATOS_ECHO MSG="WARNING: ONLY USE SET_CENTER_KINEMATIC_POSITION FOR DEBUGGING PURPOSES. YOU'RE OVERRIDING THE INTERNAL POSITIONING STATE OF THE PRINTER. PROCEED WITH CAUTION AND DO A PROPER G28 WHEN DONE."
	SET_GCODE_VARIABLE MACRO=MAYBE_HOME VARIABLE=is_kinematic_position_overriden VALUE=True
	{% set printable_x_max = printer["gcode_macro RatOS"].printable_x_max|float %}
	{% set center_x = printable_x_max / 2 %}
	SET_DUAL_CARRIAGE CARRIAGE=0 MODE=PRIMARY
	SET_KINEMATIC_POSITION X={center_x - (center_x / 2)} Y={printable_y_max / 2} Z={printer.toolhead.axis_maximum.z / 2}
	SET_DUAL_CARRIAGE CARRIAGE=1 MODE=PRIMARY
	SET_KINEMATIC_POSITION X={center_x + (center_x / 2)} Y={printable_y_max / 2} Z={printer.toolhead.axis_maximum.z / 2}
	SET_DUAL_CARRIAGE CARRIAGE=0 MODE=PRIMARY


[gcode_macro VERIFY_HYBRID_INVERTED]
gcode:
	# inverted hybrid core-xy bugfix sanity check
	{% set inverted = False %}
	{% if printer.configfile.settings.ratos_hybrid_corexy is defined and printer.configfile.settings.ratos_hybrid_corexy.inverted is defined %}
		{% if printer.configfile.settings.ratos_hybrid_corexy.inverted|lower == 'true' %}
			{% set inverted = True %}
		{% endif %}
	{% endif %}
	{% if inverted == False %}
		{ action_emergency_stop("ratos_hybrid_corexy NOT INVERTED! Inverted hybrid core-xy bugfix not detected.") }
	{% endif %}


[gcode_macro RATOS_ECHO]
gcode:
	{% set prefix = "RatOS" %}
	{% set debug = params.DEBUG|default(0)|int %}
	{% if params.PREFIX is defined %}
		{% set prefix = prefix ~ " | " ~ params.PREFIX %}
	{% endif %}
	{% set prefix = prefix ~ ":" %}
	{% set msg = "" %}
	{% if params.MSG is defined %}
		{% set msg = params.MSG %}
	{% else %}
		{% set msg = "No msg parameter provided (this is a bug or unintended use)." %}
	{% endif %}
	{% if not debug %}
		# Print to display if not a debug message
		M117 {prefix} {msg}
	{% endif %}
	RATOS_LOG PREFIX="{prefix}" MSG="{msg}"
	{% if not debug %}
		RESPOND PREFIX="{prefix}" MSG="{msg}"
	{% else %}
		CONSOLE_ECHO TITLE="{prefix}" TYPE="debug" MSG="{msg}"
	{% endif %}


### DEBUGGING MACROS
[gcode_macro ENABLE_DEBUG]
gcode:
	SET_GCODE_VARIABLE MACRO=DEBUG_ECHO VARIABLE=enabled VALUE=True
	SET_GCODE_VARIABLE MACRO=DEBUG_ECHO VARIABLE=prefix_filter VALUE="'{params.FILTER|default('')|lower}'"
	RATOS_ECHO PREFIX="DEBUG" MSG="Debugging enabled."


[gcode_macro DISABLE_DEBUG]
gcode:
	SET_GCODE_VARIABLE MACRO=DEBUG_ECHO VARIABLE=enabled VALUE=False
	RATOS_ECHO PREFIX="DEBUG" MSG="Debugging disabled."


[gcode_macro DEBUG_ECHO]
variable_enabled: False      # internal use only. Do not touch!
variable_prefix_filter: ''   # internal use only. Do not touch!
gcode:
	{% set prefix = "DEBUG" %}
	{% if params.PREFIX is defined %}
		{% set prefix = prefix ~ " - " ~ params.PREFIX %}
	{% endif %}
	{% if enabled and (prefix_filter|lower == '' or prefix_filter|lower in params.PREFIX|lower) %}
		RATOS_ECHO PREFIX="{prefix}" MSG="{params.MSG}" DEBUG=1
	{% endif %}


[gcode_macro START_FEATURE]
gcode:
  RATOS_DEBUG PREFIX="G-Code" MSG="Start {params.FEATURE} feature gcode" 
  {% set scv = printer.toolhead.square_corner_velocity %}
  {% set accel = printer.toolhead.accel %}
  {% set ratio = printer.toolhead.minimum_cruise_ratio %}
  SET_GCODE_VARIABLE MACRO="END_FEATURE" VARIABLE="scv" VALUE={scv}
  SET_GCODE_VARIABLE MACRO="END_FEATURE" VARIABLE="accel" VALUE={accel}
  SET_GCODE_VARIABLE MACRO="END_FEATURE" VARIABLE="ratio" VALUE={ratio}
  _USER_START_FEATURE FEATURE={params.FEATURE}


[gcode_macro END_FEATURE]
variable_scv: 5
variable_accel: 10000   # internal use only. Do not touch!
variable_ratio: 0.5     # internal use only. Do not touch!
gcode:
  RATOS_DEBUG PREFIX="G-Code" MSG="End {params.FEATURE} feature gcode"
  SET_VELOCITY_LIMIT SQUARE_CORNER_VELOCITY={scv} ACCEL={accel} MINIMUM_CRUISE_RATIO={ratio}
  _USER_END_FEATURE FEATURE={params.FEATURE} SCV={scv} ACCEL={accel} RATIO={ratio}


[gcode_macro _ON_LAYER_CHANGE]
variable_layer_number: 0   # internal use only. Do not touch!           
description: INTERNAL USE ONLY. Call it from the slicers after layer change custom gcode
gcode:
	# parameters 
	{% set layer = params.LAYER|int %}  

	SET_GCODE_VARIABLE MACRO=_ON_LAYER_CHANGE VARIABLE=layer_number VALUE={layer}
	SET_PRINT_STATS_INFO CURRENT_LAYER={layer}


[gcode_macro _LEARN_MORE_CALIBRATION]
gcode:
	{% set link_url = "https://github.com/HelgeKeck/RatOS/tree/documentation_v2.1/site/docs/configuration/calibration.md" %}
	{% set link_text = "RatOS Calibration Macros" %}
	{% set line_1 = '"Learn more about the <a href="%s" target="_blank" >%s</a>"' % (link_url, link_text) %}
	CONSOLE_ECHO TITLE="INFO" MSG={line_1}


[gcode_macro _LEARN_MORE_CHAMBER_FILTER]
gcode:
	{% set link_url = "https://github.com/HelgeKeck/RatOS/tree/documentation_v2.1/site/docs/configuration/chamber_filter.md" %}
	{% set link_text = "RatOS Chamber Filter Control" %}
	{% set line_1 = '"Learn more about the <a href="%s" target="_blank" >%s</a>"' % (link_url, link_text) %}
	CONSOLE_ECHO TITLE="INFO" MSG={line_1}


[gcode_macro _LEARN_MORE_FILAMENT]
gcode:
	{% set link_url = "https://github.com/HelgeKeck/RatOS/tree/documentation_v2.1/site/docs/configuration/filaments.md" %}
	{% set link_text = "RatOS Filament Macros" %}
	{% set line_1 = '"Learn more about the <a href="%s" target="_blank" >%s</a>"' % (link_url, link_text) %}
	CONSOLE_ECHO TITLE="INFO" MSG={line_1}


[gcode_macro _CONSOLE_SAVE_CONFIG]
gcode:
	M118 Click <a class="command text--blue">SAVE_CONFIG</a> to save the settings to your printer.cfg.


[gcode_macro SAVE_Z_OFFSET]
gcode:
	{% if printer.configfile.settings.beacon is defined %}
		_BEACON_SAVE_MULTIPLIER
	{% else %}
		Z_OFFSET_APPLY_PROBE
	{% endif %}
