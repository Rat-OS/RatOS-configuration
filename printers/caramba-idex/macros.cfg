# WARNING. DO NOT EDIT THIS FILE.
# To override settings from this file, you can copy and paste the relevant
# sections into your printer.cfg and change it there.

#####
# INCLUDE IDEX MACRO FILES
#####
[include ../../macros/idex/*.cfg]

[delayed_gcode _HYBRID_INIT]
initial_duration: 0.1
gcode:
	VERIFY_HYBRID_INVERTED

# Print macros. Call these from your slicer (custom g-code). 
# You can copy these to printer.cfg and modify them to your liking, or just use them as is.
# Read more here: https://rat-rig.github.io/V-CoreOS/#/slicers


[gcode_macro _START_PRINT_AFTER_HEATING_BED]
gcode:
	{% if printer["gcode_macro RatOS"].preheat_extruder|lower == 'true' %}
    {% set t = params.T|default(-1)|int %}
		{% set both_toolheads = true if params.BOTH_TOOLHEADS|default(true)|lower=='true' else false %}
    {% set min_temp = printer["gcode_macro RatOS"].preheat_extruder_temp|float %}
    {% set max_temp = printer["gcode_macro RatOS"].preheat_extruder_temp|float + 5 %}
    {% set default_toolhead = printer["gcode_macro RatOS"].default_toolhead|default(0)|int %}
		RATOS_ECHO MSG="Pre-heating extruder..."
		# Wait for extruder to reach a predefined preheat temp so an inductive probe (if present) is at a predictable temp. 
		# Also allows the bed heat to spread a little, and softens any plastic that might be stuck to the nozzle.
    {% if printer["dual_carriage"] is not defined %}
      # COREXY - HYBRID
      M104 S{min_temp}
      TEMPERATURE_WAIT SENSOR=extruder MINIMUM={min_temp} MAXIMUM={max_temp}
    {% else %}
      # IDEX
      {% if t==0 or default_toolhead==0 or both_toolheads %}
        M104 S{min_temp} T0
      {% endif %}
      {% if t==1 or default_toolhead==1 or both_toolheads %}
        M104 S{min_temp} T1
      {% endif %}
      {% if t==0 or default_toolhead==0 or both_toolheads %}
        TEMPERATURE_WAIT SENSOR=extruder MINIMUM={min_temp} MAXIMUM={max_temp}
      {% endif %}
      {% if t==1 or default_toolhead==1 or both_toolheads %}
        TEMPERATURE_WAIT SENSOR=extruder1 MINIMUM={min_temp} MAXIMUM={max_temp}
      {% endif %}
    {% endif %}
	{% endif %}
  RATOS_ECHO MSG="Adjusting Z tilt..."
  # Adjust bed tilt
  Z_TILT_ADJUST
  RATOS_ECHO MSG="Rehoming Z after Z tilt adjustment..."
  # Home again as Z will have changed after tilt adjustment and bed heating.
  G28 Z

# Macro to perform a modified z_tilt supporting stowable probes
[gcode_macro Z_TILT_ADJUST]
rename_existing: Z_TILT_ADJUST_ORIG
gcode:
	{% if printer["dual_carriage"] is defined %}
		# reset IDEX mode
		_IDEX_SINGLE
		# select default toolhead
    _SELECT_TOOL T={printer["gcode_macro RatOS"].default_toolhead|default(0)|int} TOOLSHIFT=false
	{% endif %}

	# Z-Zilt Adjust
	{% if printer["gcode_macro RatOS"].z_probe == 'stowable' %}
		DEPLOY_PROBE
	{% endif %}
	Z_TILT_ADJUST_ORIG
	{% if printer["gcode_macro RatOS"].z_probe == 'stowable' %}
		STOW_PROBE
	{% endif %}

	{% if printer["dual_carriage"] is defined %}
		# restore IDEX mode
		{% set idex_mode = printer["dual_carriage"].carriage_1|lower %}
		{% if idex_mode == "copy" %}
			_IDEX_COPY
		{% elif idex_mode == "mirror" %}
			_IDEX_MIRROR
		{% endif %}
	{% endif %}
