# WARNING. DO NOT EDIT THIS FILE.
# To override settings from this file, you can copy and paste the relevant
# sections into your printer.cfg and change it there.

[gcode_macro Z_ALIGN_MOTORS]
gcode:
  G1 X125 Y105 Z208 F4000  
  FORCE_MOVE STEPPER=stepper_z DISTANCE=20 VELOCITY=10
  FORCE_MOVE STEPPER=stepper_z DISTANCE=-20 VELOCITY=10
  SET_KINEMATIC_POSITION Z=210
  G28 Z0

[gcode_macro Z_ALIGNMENT_CALIBRATION]
gcode:
  {% set svv = printer.save_variables.variables %}
  {% set delta_z_x = svv.delta_z_x %}
  {% if delta_z_x is not number %}
    Z_ALIGN_MOTORS
    BED_MESH_CALIBRATE
  {% else %}
    {% set probe_row = (printer.configfile.settings.bed_mesh.probe_count[1] /2)|int %}
    {% set left = printer.bed_mesh.probed_matrix[probe_row][0] %}
    {% set right = (printer.bed_mesh.probed_matrix[probe_row]|last) %}
    {% set delta_z_x_new = left -right %}

    {% if (delta_z_x_new-delta_z_x)|abs > 0.1 %}
      Z_ALIGN_MOTORS
      BED_MESH_CALIBRATE
    {% endif %}
  {% endif %}
  BED_MESH_CALIBRATE_SAVE_VAR


[gcode_macro BED_MESH_CALIBRATE_SAVE_VAR]
gcode: 
   # use middle row
   {% set probe_row = (printer.configfile.settings.bed_mesh.probe_count[1] /2)|int %}
   {% set left = printer.bed_mesh.probed_matrix[probe_row][0] %}
   {% set right = (printer.bed_mesh.probed_matrix[probe_row]|last) %}
   {% set delta = left -right %}
   SAVE_VARIABLE VARIABLE=delta_z_x VALUE='{delta}'




[gcode_macro G80]
gcode:
 G28 
 BED_MESH_CALIBRATE
 Z_ALIGNMENT_CALIBRATION
 G1 X0 Y0 Z0.4 F4000


[homing_override]
gcode:
 G1 Z3
 G28 X0 Y0
 G1 X125 Y105 F5000
 G28 Z0
axes: Z
set_position_x: 0
set_position_y: 0
set_position_z: 0



[gcode_macro G81]
gcode:
 BED_MESH_OUTPUT

[gcode_macro M300]
default_parameter_S=1000
default_parameter_P=100
gcode:
 SET_PIN PIN=BEEPER_pin VALUE={S}
 G4 P{P}
 SET_PIN PIN=BEEPER_pin VALUE=0

[gcode_macro M600]
variable_extr_temp: 0
default_parameter_X: 100
default_parameter_Y: 0
default_parameter_Z: 10
gcode:
 PAUSE
 G91
 G1 E-.8 F2700
 G1 Z{Z}
 G90
 G1 X{X} Y{Y} F3000

[gcode_macro LOAD_FILAMENT]
gcode:
 M117 Loading Filament...
 G92 E0.0
 G91
 G1 E40 F400
 G1 E30 F400
 G1 E25 F200
 G90
 G92 E0.0
 M400
 M117 Load Complete
 UPDATE_DELAYED_GCODE ID=clear_display DURATION=5

[gcode_macro UNLOAD_FILAMENT]
gcode:
 M117 Unloading Filament...
 G92 E0.0
 G91
 G1 E-45 F5200
 G1 E-15 F1000
 G1 E-20 F1000
 G90
 G92 E0.0
 M400
 M117 Remove Filament Now!
 M300 S300 P1000
 UPDATE_DELAYED_GCODE ID=clear_display DURATION=5

[gcode_macro CANCEL_PRINT]
rename_existing: BASE_CANCEL_PRINT
gcode:
  TURN_OFF_HEATERS
  CLEAR_PAUSE
  SDCARD_RESET_FILE
  BASE_CANCEL_PRINT




[gcode_macro PAUSE]
rename_existing: BASE_PAUSE
# change this if you need more or less extrusion
variable_extrude: 1.0
gcode:
  ##### read E from pause macro #####
  {% set E = printer["gcode_macro PAUSE"].extrude|float %}
  ##### set park positon for x and y #####
  # default is your max posion from your printer.cfg
  {% set x_park = printer.toolhead.axis_maximum.x|float - 5.0 %}
  {% set y_park = printer.toolhead.axis_maximum.y|float - 5.0 %}
  ##### calculate save lift position #####
  {% set max_z = printer.toolhead.axis_maximum.z|float %}
  {% set act_z = printer.toolhead.position.z|float %}
  {% if act_z < (max_z - 2.0) %}
      {% set z_safe = 2.0 %}
  {% else %}
      {% set z_safe = max_z - act_z %}
  {% endif %}
  ##### end of definitions #####
  SAVE_GCODE_STATE NAME=PAUSE_state
  BASE_PAUSE
  G91
  G1 E-{E} F2100
  G1 Z{z_safe} F900
  G90
  G1 X{x_park} Y{y_park} F6000

[gcode_macro RESUME]
rename_existing: BASE_RESUME
gcode:
  ##### read E from pause macro #####
  {% set E = printer["gcode_macro PAUSE"].extrude|float %}
  ##### end of definitions #####
  G91
  G1 E{E} F2100
  RESTORE_GCODE_STATE NAME=PAUSE_state
  BASE_RESUME
